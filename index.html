ì´ˆëŒ€ë§í¬ ìë™ ì…ì¥, í™”ë©´ í™•ëŒ€ ë°©ì§€, ê²½í’ˆëª… ê³µìœ  ìˆ˜ì •, ì¢…ë£Œ ì‹œê°„ í‘œì‹œë¥¼ ë°˜ì˜í•œ ì™„ì „í•œ HTML íŒŒì¼ì…ë‹ˆë‹¤:

```html
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>ê¸°í”„í‹°ì½˜ ë°°í‹€ ì•„ì¼€ì´ë“œ Â· ì‹¤ì‹œê°„ ìˆœìœ„ Â· ë“±ìˆ˜ë³„ ê²½í’ˆ</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg: #0e0f12;
      --card: #14161a;
      --muted: #8f9bb3;
      --text: #e7eaf3;
      --acc: #6ae3ff;
      --acc2:#7cf2b5;
      --warn:#ff9c6e;
      --err:#ff6b7a;
      --good:#86f28e;
      --glass: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent; -webkit-user-select: none; user-select: none;}
    input, textarea { -webkit-user-select: text; user-select: text; }
    html,body{height:100%; touch-action: pan-y; overflow-x: hidden;}
    body{
      margin:0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 10% -10%, #1a1d24 0, transparent 60%),
        radial-gradient(1000px 600px at 110% 10%, #141922 0, transparent 60%),
        linear-gradient(180deg, #0b0c0f, #0f1116 40%, #0e0f12);
      min-height:100%;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    /* í™•ëŒ€ ë°©ì§€ ì¶”ê°€ */
    input:focus, select:focus, textarea:focus, button:focus {
      font-size: 16px !important;
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px }
    header{
      position:sticky; top:0; z-index:8;
      background:linear-gradient(180deg, rgba(10,11,14,.9), rgba(10,11,14,.65) 70%, transparent);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      border-bottom:1px solid var(--border);
    }
    .bar{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:10px 16px; flex-wrap:wrap }
    .logo{display:flex; gap:8px; align-items:center; font-weight:800; letter-spacing:.2px}
    .logo .mark{
      width:24px; height:24px; border-radius:8px; display:grid; place-items:center;
      background: conic-gradient(from 210deg, #3be7f7, #7cf2b5, #87b2ff);
      box-shadow: inset 0 0 0 3px rgba(0,0,0,.25), 0 8px 22px rgba(58, 228, 255, .25);
      color:#0b0c0f; font-weight:900; font-size:14px;
    }
    .logo .hint{font-size:11px}
    .pill{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--glass); color:var(--text); font-weight:600; font-size:13px}
    .pill code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.95em}
    .btn{
      appearance:none; border:1px solid var(--border); background:var(--glass); color:var(--text);
      padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; font-size:14px;
      transition: .15s transform ease, .2s background ease, .2s border ease, .2s color ease;
      touch-action: manipulation; -webkit-touch-callout: none;
    }
    .btn[disabled]{opacity:.55; cursor:not-allowed}
    .btn:active{transform: scale(0.98); filter: brightness(1.2)}
    .btn:hover{transform: translateY(-1px); border-color:#3ae5ff44; background: rgba(122,240,255,.08)}
    .btn.acc{ background: linear-gradient(180deg, #1f3340, #15232b); border-color:#2a8ca955; color:#b8f2ff; box-shadow: inset 0 -4px 18px rgba(82,193,213,.25), 0 10px 24px rgba(46,178,208,.25) }
    .btn.good{ background: linear-gradient(180deg, #1c3523, #12271a); border-color:#2a9d5250; color:#bff5d0; box-shadow: inset 0 -4px 18px rgba(90,205,145,.22), 0 10px 24px rgba(90,205,145,.2) }
    .btn.warn{ background: linear-gradient(180deg, #3b2417, #2a1b12); border-color:#ff9c6e55; color:#ffd8c8 }
    .btn.err{ background: linear-gradient(180deg, #3b1620, #2a1117); border-color:#ff6b7a55; color:#ffd0d6 }
    .grid{display:grid; gap:16px}
    .cols{grid-template-columns: 1.3fr .7fr}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border); border-radius:16px; box-shadow: var(--shadow); padding:16px;
    }
    h1,h2,h3,h4{margin:0 0 8px 0}
    .muted{color:var(--muted)}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .sp{flex:1}
    .field{display:flex; flex-direction:column; gap:8px}
    .field input, .field select, .field textarea{
      background:var(--card); border:1px solid var(--border); color:var(--text);
      border-radius:10px; padding:10px 12px; outline:none; width:100%; font-size:16px;
      touch-action: manipulation; -webkit-appearance: none;
    }
    .hint{font-size:.85em; color:var(--muted)}
    .section{margin-top:16px}
    .badge{display:inline-flex; padding:.2rem .4rem; border-radius:6px; font-weight:800; font-size:.8em; border:1px solid var(--border); background:rgba(255,255,255,.05)}
    .leader{ max-height: 480px; overflow:auto; border-radius:12px; border:1px solid var(--border); background: rgba(255,255,255,.04); -webkit-overflow-scrolling: touch; }
    .leader table{width:100%; border-collapse:collapse; font-variant-numeric: tabular-nums; font-size:13px}
    .leader th, .leader td{padding:8px 10px; border-bottom:1px solid var(--border)}
    .leader tr:hover{background: rgba(255,255,255,.05)}
    .game-area{min-height:380px; border-radius:14px; border:1px dashed #2a2f39; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)); display:grid; place-items:center; position:relative; overflow:hidden; touch-action: none;}
    .center{display:grid; place-items:center; text-align:center; gap:12px; padding:12px}
    .timer{font-variant-numeric: tabular-nums; font-weight:800}
    .big{font-size:24px; font-weight:900}
    .xl{font-size:36px; font-weight:900}
    .hidden{display:none !important}
    .footnote{font-size:.85em; color:var(--muted)}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%); bottom:20px; z-index:1000;
      background:#14161a; border:1px solid var(--border); padding:10px 14px; border-radius:10px; box-shadow: var(--shadow);
      opacity:0; pointer-events:none; transition:.25s opacity ease, .25s transform ease; font-size:14px; max-width:90vw;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-6px)}
    .chip{padding:.2rem .45rem; background:rgba(255,255,255,.06); border:1px solid var(--border); border-radius:999px; font-weight:800; font-size:.8em}
    .tag{display:inline-block; padding:.2rem .45rem; border-radius:6px; border:1px solid var(--border); background:rgba(255,255,255,.05); font-size:.8em}
    .gamegrid{display:grid; grid-template-columns: repeat(2, minmax(280px, 1fr)); gap:12px; width:100%}
    .k{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
    
    /* ê²½í’ˆ í”„ë¦¬ë·° */
    .prize-preview{ display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; margin-top:8px }
    .prize-card{ border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#0f1217; width:180px; box-shadow: var(--shadow) }
    .prize-card .thumb{width:100%; aspect-ratio: 1 / 1; object-fit:cover; display:block}
    .prize-card .meta{padding:6px 8px; font-size:.8em; display:flex; gap:6px; align-items:center}
    .overlay{ position:absolute; inset:0; display:grid; place-items:center; background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.6)); color:#fff; font-weight:900 }
    .divider{height:1px; background:var(--border); margin:12px 0}

    /* Mole grid */
    .mole-grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; width:100%; max-width:360px; margin:0 auto; }
    .mole-cell{ aspect-ratio:1/1; border:1px solid #2a2f39; border-radius:10px; background:#0d1216; position:relative; overflow:hidden; cursor:pointer; touch-action: none; }
    .mole{ position:absolute; left:50%; top:100%; transform:translate(-50%, -50%); width:70%; aspect-ratio:1/1; border-radius:50%;
      background:radial-gradient(circle at 50% 60%, #6ae3ff 0, #318ea1 60%, #1b3f47 100%); transition:.12s top ease, .05s filter ease; box-shadow: 0 8px 24px rgba(0,0,0,.35); pointer-events:none; }
    .mole[data-up="1"]{ pointer-events:auto; }

    .game-disabled{ position:relative; opacity:.6 }
    .game-disabled::after{ content:'ë‹¤ë¥¸ ê²Œì„ ì§„í–‰ ì¤‘'; position:absolute; inset:0; display:grid; place-items:center; font-weight:900; color:#fff; background:rgba(0,0,0,.5); border-radius:14px }
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:999; background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.6)); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); padding:16px }

    /* Rhythm game */
    .rhythm-area{ position:relative; height:420px; width:100%; max-width:640px; background:linear-gradient(180deg, #0c0f14, #0a0d12); border-radius:12px; border:1px dashed #2a2f39; overflow:hidden; touch-action: none; margin:0 auto }
    .lane{ position:absolute; top:0; bottom:0; width:25%; border-left:1px solid #1d2430; border-right:1px solid #1d2430; }
    .lane:nth-child(1){ left:0% } .lane:nth-child(2){ left:25% } .lane:nth-child(3){ left:50% } .lane:nth-child(4){ left:75% }
    .hitline{ position:absolute; left:0; right:0; bottom:54px; height:2px; background:#445; box-shadow:0 0 12px rgba(110,160,255,.4) inset }
    .note{ position:absolute; width:55%; left:22.5%; height:16px; background:linear-gradient(180deg, #9bd1ff, #4fa3ff); border-radius:6px; box-shadow:0 8px 18px rgba(0,0,0,.35) }
    .keyhints{ position:absolute; left:0; right:0; bottom:8px; display:flex; justify-content:space-around; padding:0 16px; color:#9fb3ff; font-weight:900 }
    .keycap{ padding:.3rem .5rem; border:1px solid #2a3658; background:#0e1320; border-radius:6px; min-width:36px; text-align:center; cursor:pointer; touch-action: none; font-size:12px }
    .keycap:active{ filter:brightness(1.4) }

    /* Simon (íŒ¨í„´ ë©”ëª¨ë¦¬) */
    .simon-grid{ display:grid; grid-template-columns: repeat(2, 120px); gap:10px; justify-content:center }
    .simon-pad{ width:120px; height:120px; border-radius:10px; cursor:pointer; box-shadow: inset 0 0 0 2px rgba(255,255,255,.05); touch-action: none; }
    .simon-pad.pad1{ background:#2a3b4a } .simon-pad.pad2{ background:#3a2f49 } .simon-pad.pad3{ background:#2d4a39 } .simon-pad.pad4{ background:#4a2a2a }
    
    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 980px){
      .cols{grid-template-columns: 1fr}
      .gamegrid{grid-template-columns: 1fr}
      .xl{font-size:28px}
      .big{font-size:20px}
      .bar{padding:8px 12px; gap:6px}
      .logo .mark{width:20px; height:20px; font-size:12px}
      .btn{padding:7px 10px; font-size:13px}
      .pill{padding:5px 8px; font-size:12px}
      .card{padding:12px}
      .game-area{min-height:320px}
      .rhythm-area{height:360px}
      .mole-grid{max-width:300px; gap:6px}
      .simon-grid{grid-template-columns: repeat(2, 100px); gap:8px}
      .simon-pad{width:100px; height:100px}
      .leader{max-height:400px}
      .leader th, .leader td{padding:6px 8px; font-size:12px}
      .prize-card{width:140px}
      h2{font-size:20px} h3{font-size:16px}
    }
    @media (max-width: 480px){
      .wrap{padding:12px}
      .logo .hint{display:none}
      .bar{justify-content:center}
      .game-area{min-height:280px}
      .mole-grid{max-width:260px}
      .rhythm-area{height:320px}
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="logo">
        <div class="mark">G</div>
        <div>
          ê¸°í”„í‹°ì½˜ ë°°í‹€
          <div class="hint">ì‹¤ì‹œê°„ ìˆœìœ„ Â· ë“±ìˆ˜ë³„ ê²½í’ˆ</div>
        </div>
      </div>
      <div class="row">
        <div class="pill"><span>ë°©</span> <code id="roomCodeBadge">-</code> <button id="copyRoom" class="btn">ë³µì‚¬</button></div>
        <div class="pill"><span>ë‚¨ì€</span> <span class="timer" id="countdown">--:--</span></div>
        <button id="shareLinkBtn" class="btn" title="ë°© ë§í¬ ê³µìœ ">ê³µìœ </button>
        <button id="hostBtn" class="btn" title="ë°©ì¥ ì„¤ì •">ë°©ì¥</button>
        <button id="leaveBtn" class="btn warn" title="ë‚˜ê°€ê¸°">ë‚˜ê°€ê¸°</button>
      </div>
    </div>
  </header>

  <div class="wrap grid cols">
    <main class="card">
      <!-- ë©”ì¸(ì…ì¥/ìƒì„±) -->
      <div id="joinSection" class="section">
        <h2>ì‹œì‘í•˜ê¸°</h2>
        <div class="hint">ë°©ì„ ë§Œë“¤ ë•Œ í•œ ê°€ì§€ ê²Œì„ë§Œ ì„ íƒí•´ ê²½ìŸí•©ë‹ˆë‹¤. ë¼ìš´ë“œ ì¢…ë£Œ í›„ ë“±ìˆ˜ë³„ ê²½í’ˆì„ ìë™ ì œê³µí•  ìˆ˜ ìˆì–´ìš”.</div>
        <div class="section grid" style="grid-template-columns:1fr 1fr">
          <!-- ì°¸ì—¬ -->
          <div class="card">
            <h3>ë°© ì°¸ì—¬</h3>
            <div class="field">
              <label>ë‹‰ë„¤ì„</label>
              <input id="nickInput" placeholder="ì˜ˆ: ë³„ë¹›í† ë¼" maxlength="16">
              <div class="hint">ì´ ê¸°ê¸°ì—ì„œëŠ” í•œ ë‹‰ë„¤ì„ë§Œ ì‚¬ìš© ê°€ëŠ¥</div>
            </div>
            <div class="field">
              <label>ë°©ì½”ë“œ</label>
              <input id="roomInput" placeholder="ì˜ˆ: ABC123" maxlength="16">
              <div class="hint">ì´ˆëŒ€ ë§í¬ì˜ ë°©ì½”ë“œ ìë™ ì…ë ¥</div>
            </div>
            <div class="row">
              <button id="joinBtn" class="btn acc">ë°© ì°¸ì—¬</button>
            </div>
          </div>

          <!-- ìƒì„±(ë°©ì¥) -->
          <div class="card">
            <h3>ìƒˆë¡œìš´ ë°© ë§Œë“¤ê¸°</h3>
            <div class="field">
              <label>ê²½ìŸ ê²Œì„ ì„ íƒ</label>
              <select id="createGameSelect">
                <option value="reaction">ë°˜ì‘ì†ë„ ì±Œë¦°ì§€</option>
                <option value="aim">ì—ì„ íŠ¸ë ˆì´ë„ˆ</option>
                <option value="mole">ë‘ë”ì§€ ì¡ê¸°</option>
                <option value="math">ìˆ˜í•™ ëŸ¬ì‹œ</option>
                <option value="typing">íƒ€ì ìŠ¤í”„ë¦°íŠ¸</option>
                <option value="stroop">ìƒ‰ìƒ ìŠ¤ë£¨í”„</option>
                <option value="simon">íŒ¨í„´ ë©”ëª¨ë¦¬</option>
                <option value="rhythm">ë¦¬ë“¬ ë§ˆìŠ¤í„°</option>
              </select>
            </div>
            <div class="field">
              <label>ë¼ìš´ë“œ ì‹œê°„</label>
              <select id="durationSel">
                <option value="5">5ë¶„</option>
                <option value="10" selected>10ë¶„</option>
                <option value="15">15ë¶„</option>
                <option value="20">20ë¶„</option>
              </select>
            </div>
            <div class="field">
              <label>ì‹œë„ ì œí•œ(0=ë¬´ì œí•œ)</label>
              <input id="createAttemptLimit" type="number" min="0" value="0">
            </div>

            <div class="section">
              <h4>ë“±ìˆ˜ë³„ ê²½í’ˆ</h4>
              <div class="hint">ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•˜ì„¸ìš”. í•´ë‹¹ ë“±ìˆ˜ë§Œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
              <div class="grid" style="grid-template-columns:1fr">
                <div class="field">
                  <label>1ë“± ê²½í’ˆ</label>
                  <input type="file" id="createPrizeFile1" accept="image/*">
                  <input id="createPrizeName1" placeholder="ì˜ˆ: ìŠ¤íƒ€ë²…ìŠ¤ ì•„ë©”ë¦¬ì¹´ë…¸">
                  <div id="createPrizePrev1" class="prize-preview"></div>
                </div>
                <div class="field">
                  <label>2ë“± ê²½í’ˆ</label>
                  <input type="file" id="createPrizeFile2" accept="image/*">
                  <input id="createPrizeName2" placeholder="ì˜ˆ: ë² ìŠ¤í‚¨ë¼ë¹ˆìŠ¤ íŒŒì¸íŠ¸">
                  <div id="createPrizePrev2" class="prize-preview"></div>
                </div>
                <div class="field">
                  <label>3ë“± ê²½í’ˆ</label>
                  <input type="file" id="createPrizeFile3" accept="image/*">
                  <input id="createPrizeName3" placeholder="ì˜ˆ: í¸ì˜ì  3ì²œì›ê¶Œ">
                  <div id="createPrizePrev3" class="prize-preview"></div>
                </div>
              </div>
            </div>

            <div class="row">
              <button id="createRoomBtn" class="btn good">ìƒˆ ë°© ìƒì„±</button>
              <span class="hint">5ì´ˆ í›„ ì‹œì‘</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ë¡œë¹„/ê²Œì„ -->
      <div id="lobbySection" class="section hidden">
        <div class="row">
          <h2>ê²Œì„</h2>
          <span class="chip" id="selfBadge">-</span>
          <span class="chip" id="gameBadge">-</span>
          <span class="chip" id="limitBadge">-</span>
          <div class="sp"></div>
          <button id="shareBtn" class="btn">ì´ˆëŒ€</button>
        </div>
        <div class="hint">ì„ íƒëœ ê²Œì„ìœ¼ë¡œ ê²½ìŸí•©ë‹ˆë‹¤. ì¢…ë£Œ ì‹œ ë“±ìˆ˜ë³„ ê²½í’ˆ ì œê³µ!</div>

        <div class="section gamegrid" id="gameGrid">
          <!-- Reaction -->
          <div class="card game-card" data-game="reaction">
            <div class="row"><h3>ë°˜ì‘ì†ë„</h3><span class="badge">3 ë¼ìš´ë“œ</span><span class="sp"></span><span class="badge" id="attemptBad_reaction">-</span></div>
            <div class="hint">ë…¹ìƒ‰ ì‹ í˜¸ í›„ í´ë¦­! í‰ê·  msê°€ ë‚®ì„ìˆ˜ë¡ ê³ ë“ì </div>
            <div class="game-area" id="reactionArea">
              <div class="center">
                <div class="xl">ì¤€ë¹„!</div>
                <div class="hint">3íšŒ ì¸¡ì •</div>
                <button class="btn acc" id="reactionStart">ì‹œì‘</button>
              </div>
            </div>
            <div class="row section">
              <div class="badge">ìµœê³ : <span id="reactionBest">-</span></div>
            </div>
          </div>

          <!-- Aim -->
          <div class="card game-card" data-game="aim">
            <div class="row"><h3>ì—ì„</h3><span class="badge">30ì´ˆ</span><span class="sp"></span><span class="badge" id="attemptBad_aim">-</span></div>
            <div class="hint">íƒ€ê²Ÿ í´ë¦­! ëª…ì¤‘/ì •í™•ë„ë¡œ ì ìˆ˜</div>
            <div class="game-area" id="aimArea" style="height:320px; position:relative">
              <div class="center">
                <div class="xl">ì—ì„</div>
                <button class="btn acc" id="aimStart">ì‹œì‘</button>
              </div>
            </div>
            <div class="row section">
              <div class="badge">ìµœê³ : <span id="aimBest">-</span></div>
              <div class="badge">ì •í™•ë„: <span id="aimAcc">-</span></div>
            </div>
          </div>

          <!-- Mole -->
          <div class="card game-card" data-game="mole">
            <div class="row"><h3>ë‘ë”ì§€</h3><span class="badge">30ì´ˆ</span><span class="sp"></span><span class="badge" id="attemptBad_mole">-</span></div>
            <div class="hint">ë‘ë”ì§€ í´ë¦­! ë¹ˆ ì¹¸ í´ë¦­ ê°ì </div>
            <div class="game-area" id="moleArea">
              <div class="center" style="width:100%">
                <div class="mole-grid" id="moleGrid"></div>
                <div class="row" style="margin-top:8px">
                  <button class="btn acc" id="moleStart">ì‹œì‘</button>
                  <div class="sp"></div>
                  <div class="badge">ëª…ì¤‘: <span id="moleHits">0</span></div>
                  <div class="badge">ì˜¤í´ë¦­: <span id="moleMiss">0</span></div>
                  <div class="badge"><span id="moleTime">--</span>s</div>
                </div>
              </div>
            </div>
            <div class="row section">
              <div class="badge">ìµœê³ : <span id="moleBest">-</span></div>
            </div>
          </div>

          <!-- Math -->
          <div class="card game-card" data-game="math">
            <div class="row"><h3>ìˆ˜í•™</h3><span class="badge">60ì´ˆ</span><span class="sp"></span><span class="badge" id="attemptBad_math">-</span></div>
            <div class="hint">ë¹ ë¥´ê²Œ í’€ìˆ˜ë¡ ê³ ë“ì </div>
            <div class="game-area" id="mathArea">
              <div class="center">
                <div class="big" id="mathQ">3 + 4 Ã— 2 = ?</div>
                <div class="row">
                  <input id="mathAns" class="k" style="width:180px; font-size:16px" placeholder="ì •ë‹µ" inputmode="numeric" />
                  <button class="btn acc" id="mathStart">ì‹œì‘</button>
                </div>
                <div class="row" style="gap:6px">
                  <div class="badge">ì •ë‹µ: <span id="mathOk">0</span></div>
                  <div class="badge">ì—°ì†: <span id="mathStreak">0</span></div>
                  <div class="badge"><span id="mathTime">--</span>s</div>
                </div>
              </div>
            </div>
            <div class="row section">
              <div class="badge">ìµœê³ : <span id="mathBest">-</span></div>
            </div>
          </div>

          <!-- Typing -->
          <div class="card game-card" data-game="typing">
            <div class="row"><h3>íƒ€ì</h3><span class="badge">20ì´ˆ</span><span class="sp"></span><span class="badge" id="attemptBad_typing">-</span></div>
            <div class="hint">ë‹¨ì–´ë¥¼ ë¹ ë¥´ê³  ì •í™•í•˜ê²Œ!</div>
            <div class="game-area" id="typingArea">
              <div class="center">
                <div class="big" id="typingWord">ready</div>
                <input id="typingInput" class="k" style="width:200px; font-size:16px" placeholder="ì…ë ¥ í›„ Enter" disabled />
                <div class="row">
                                    <button class="btn acc" id="typingStart">ì‹œì‘</button>
                  <div class="sp"></div>
                  <div class="badge">ì™„ë£Œ: <span id="typingOk">0</span></div>
                  <div class="badge"><span id="typingAcc">0%</span></div>
                  <div class="badge"><span id="typingTime">--</span>s</div>
                </div>
              </div>
            </div>
            <div class="row section">
              <div class="badge">ìµœê³ : <span id="typingBest">-</span></div>
            </div>
          </div>

          <!-- Stroop -->
          <div class="card game-card" data-game="stroop">
            <div class="row"><h3>ìŠ¤ë£¨í”„</h3><span class="badge">30ì´ˆ</span><span class="sp"></span><span class="badge" id="attemptBad_stroop">-</span></div>
            <div class="hint">ê¸€ì ìƒ‰ì— ë§ëŠ” ë²„íŠ¼ í´ë¦­!</div>
            <div class="game-area" id="stroopArea" style="min-height:320px">
              <div class="center">
                <div class="xl" id="stroopWord">BLUE</div>
                <div class="row" id="stroopBtns"></div>
                <div class="row">
                  <button class="btn acc" id="stroopStart">ì‹œì‘</button>
                  <div class="sp"></div>
                  <div class="badge">ì •ë‹µ: <span id="stroopOk">0</span></div>
                  <div class="badge">ì˜¤ë‹µ: <span id="stroopWrong">0</span></div>
                  <div class="badge"><span id="stroopTime">--</span>s</div>
                </div>
              </div>
            </div>
            <div class="row section">
              <div class="badge">ìµœê³ : <span id="stroopBest">-</span></div>
            </div>
          </div>

          <!-- Simon -->
          <div class="card game-card" data-game="simon">
            <div class="row"><h3>íŒ¨í„´ ë©”ëª¨ë¦¬</h3><span class="badge">ë¬´ì œí•œ</span><span class="sp"></span><span class="badge" id="attemptBad_simon">-</span></div>
            <div class="hint">ë¹›ë‚˜ëŠ” ìˆœì„œ ê¸°ì–µ í›„ í´ë¦­!</div>
            <div class="game-area" id="simonArea" style="min-height:320px">
              <div class="center">
                <div class="simon-grid">
                  <div class="simon-pad pad1" id="simonPad1"></div>
                  <div class="simon-pad pad2" id="simonPad2"></div>
                  <div class="simon-pad pad3" id="simonPad3"></div>
                  <div class="simon-pad pad4" id="simonPad4"></div>
                </div>
                <div class="row">
                  <button class="btn acc" id="simonStart">ì‹œì‘</button>
                  <div class="sp"></div>
                  <div class="badge">ë¼ìš´ë“œ: <span id="simonRound">0</span></div>
                  <div class="badge">ìµœê³ : <span id="simonBestRound">0</span></div>
                </div>
              </div>
            </div>
            <div class="row section">
              <div class="badge">ìµœê³ : <span id="simonBest">-</span></div>
            </div>
          </div>

          <!-- Rhythm -->
          <div class="card game-card" data-game="rhythm">
            <div class="row"><h3>ë¦¬ë“¬</h3><span class="badge">ì•½ 40ì´ˆ</span><span class="sp"></span><span class="badge" id="attemptBad_rhythm">-</span></div>
            <div class="hint">D F J K í‚¤ ë˜ëŠ” ì•„ë˜ ë²„íŠ¼ í„°ì¹˜!</div>
            <div class="game-area" id="rhythmArea">
              <div class="center" style="width:100%">
                <div class="rhythm-area" id="rhythmStage">
                  <div class="lane"></div><div class="lane"></div><div class="lane"></div><div class="lane"></div>
                  <div class="hitline"></div>
                  <div class="keyhints">
                    <div class="keycap" data-lane="0">D</div>
                    <div class="keycap" data-lane="1">F</div>
                    <div class="keycap" data-lane="2">J</div>
                    <div class="keycap" data-lane="3">K</div>
                  </div>
                </div>
                <div class="row" style="margin-top:8px">
                  <button class="btn acc" id="rhythmStart">ì‹œì‘</button>
                  <div class="sp"></div>
                  <div class="badge">ì ìˆ˜: <span id="rhythmScore">0</span></div>
                  <div class="badge">ì½¤ë³´: <span id="rhythmCombo">0</span></div>
                  <div class="badge"><span id="rhythmAcc">0%</span></div>
                </div>
              </div>
            </div>
            <div class="row section">
              <div class="badge">ìµœê³ : <span id="rhythmBest">-</span></div>
            </div>
          </div>

        </div>
      </div>

      <!-- ì¢…ë£Œ/ë°œí‘œ -->
      <div id="winnerSection" class="section hidden">
        <div class="card">
          <div class="row">
            <h2>ë¼ìš´ë“œ ì¢…ë£Œ</h2>
            <span class="badge">ìˆœìœ„ ë°œí‘œ</span>
            <div class="sp"></div>
            <button class="btn" id="backToMainBtn">ë©”ì¸ìœ¼ë¡œ</button>
          </div>
          <div id="winnerBox" class="section">ê²°ê³¼ ëŒ€ê¸° ì¤‘...</div>
          <div id="prizeBox" class="section hidden">
            <div class="divider"></div>
            <h3>ë‚´ ê²½í’ˆ</h3>
            <div id="prizeContent"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- ìˆœìœ„íŒ -->
    <aside class="card">
      <div class="row">
        <h3>ì‹¤ì‹œê°„ ìˆœìœ„</h3>
        <span class="tag" id="lbStatus">ì—°ê²° ëŒ€ê¸°</span>
        <div class="sp"></div>
        <button class="btn" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div class="leader section">
        <table>
          <thead>
            <tr>
              <th style="width:40px">#</th>
              <th>ë‹‰ë„¤ì„</th>
              <th style="width:80px">ì ìˆ˜</th>
              <th style="width:160px">ì„¸ë¶€</th>
            </tr>
          </thead>
          <tbody id="leaderBody"></tbody>
        </table>
      </div>
      <div class="section">
        <div class="footnote">ì„ íƒëœ ê²Œì„ì˜ ìµœê³  ê¸°ë¡ ê¸°ë°˜</div>
      </div>
    </aside>
  </div>

  <!-- ë°©ì¥ ëª¨ë‹¬ -->
  <div class="modal" id="hostModal" aria-hidden="true">
    <div class="card" style="width:min(920px, 96vw); max-height:90vh; overflow:auto">
      <div class="row">
        <h3>ë°©ì¥ ì„¤ì •</h3>
        <span class="tag" id="hostRoomTag">ë°© -</span>
        <div class="sp"></div>
        <button class="btn" id="closeHost">ë‹«ê¸°</button>
      </div>
      <div class="divider"></div>

      <div class="grid" style="grid-template-columns:1fr">
        <div>
          <h4>ë°©/ë¼ìš´ë“œ</h4>
          <div class="field">
            <label>ë°©ì½”ë“œ</label>
            <input id="hostRoomCode" readonly>
          </div>
          <div class="row">
            <div class="field" style="flex:1">
              <label>ì‹œì‘ ì‹œê°</label>
              <input id="hostStartAt" type="datetime-local">
            </div>
            <div class="field" style="flex:1">
              <label>ì¢…ë£Œ ì‹œê°</label>
              <input id="hostEndAt" type="datetime-local">
            </div>
          </div>
          <div class="field">
            <label>ê²½ìŸ ê²Œì„</label>
            <select id="hostGameSelect">
              <option value="reaction">ë°˜ì‘ì†ë„</option>
              <option value="aim">ì—ì„</option>
              <option value="mole">ë‘ë”ì§€</option>
              <option value="math">ìˆ˜í•™ ëŸ¬ì‹œ</option>
              <option value="typing">íƒ€ì</option>
              <option value="stroop">ìŠ¤ë£¨í”„</option>
              <option value="simon">íŒ¨í„´ ë©”ëª¨ë¦¬</option>
              <option value="rhythm">ë¦¬ë“¬ ë§ˆìŠ¤í„°</option>
            </select>
          </div>
          <div class="field">
            <label>ì‹œë„ ì œí•œ(0=ë¬´ì œí•œ)</label>
            <input id="hostAttemptLimit" type="number" min="0" value="0">
          </div>
          <div class="row">
            <button class="btn acc" id="saveHostMeta">ì„¤ì • ì €ì¥</button>
            <button class="btn warn" id="hostEndNow">ì§€ê¸ˆ ì¢…ë£Œ</button>
          </div>
        </div>

        <div>
          <h4>ë“±ìˆ˜ë³„ ê²½í’ˆ</h4>
          <div class="grid" style="grid-template-columns:1fr">
            <div class="field">
              <label>1ë“± ì´ë¯¸ì§€</label>
              <input type="file" id="prizeFile1" accept="image/*">
              <input id="prizeName1" placeholder="1ë“± ê²½í’ˆ ì´ë¦„">
              <div id="prizePreview1" class="prize-preview"></div>
            </div>
            <div class="field">
              <label>2ë“± ì´ë¯¸ì§€</label>
              <input type="file" id="prizeFile2" accept="image/*">
              <input id="prizeName2" placeholder="2ë“± ê²½í’ˆ ì´ë¦„">
              <div id="prizePreview2" class="prize-preview"></div>
            </div>
            <div class="field">
              <label>3ë“± ì´ë¯¸ì§€</label>
              <input type="file" id="prizeFile3" accept="image/*">
              <input id="prizeName3" placeholder="3ë“± ê²½í’ˆ ì´ë¦„">
              <div id="prizePreview3" class="prize-preview"></div>
            </div>
          </div>
          <div class="row">
            <button class="btn good" id="savePrizes">ë¡œì»¬ ì €ì¥</button>
            <div class="sp"></div>
            <button class="btn acc" id="publishPrizes">ë°©ì— ë°°í¬</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">ì•Œë¦¼</div>

  <script type="module">
    // í™”ë©´ í™•ëŒ€ ë°©ì§€
    document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
    document.addEventListener('touchmove', function(e) { 
      if (e.scale !== 1) { e.preventDefault(); }
    }, { passive: false });
    
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyAE0RssQGTXBi8RzrtNe1Le6SymxFmZSjY",
      authDomain: "lucky-b2ad8.firebaseapp.com",
      projectId: "lucky-b2ad8",
      storageBucket: "lucky-b2ad8.firebasestorage.app",
      messagingSenderId: "674619666684",
      appId: "1:674619666684:web:a8252ca2f8f23e40b9e779"
    };

    // ìœ í‹¸
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const delay = ms => new Promise(r => setTimeout(r, ms));
    const clamp = (n, mi, ma) => Math.max(mi, Math.min(ma, n));
    const rnd = (a,b) => Math.floor(Math.random()*(b-a+1))+a;
    const uid = () => ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c=>(c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
    const now = () => Date.now();
    const fmt = n => new Intl.NumberFormat('ko-KR').format(n);
    const pad = (n,d=2)=> String(n).padStart(d,'0');
    const toast = (t)=>{ const el=$('#toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2500) };
    const copy = async (txt)=>{ try{ await navigator.clipboard.writeText(txt); toast('ë³µì‚¬ ì™„ë£Œ'); }catch(e){ toast('ë³µì‚¬ ì‹¤íŒ¨') } };
    const load = (k,def=null)=>{ try{ const v = localStorage.getItem(k); return v?JSON.parse(v):def }catch{ return def } }
    const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
    const downloadDataURL = (dataURL, filename='prize.jpg')=>{
      const a=document.createElement('a'); a.href=dataURL; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
    };

    // ì´ë¯¸ì§€ ì••ì¶•
    async function compressImage(file, maxDim=1024, qualityStart=0.8){
      const imgURL = URL.createObjectURL(file);
      const img = new Image(); img.src = imgURL;
      await new Promise(res=> { img.onload = res; img.onerror = res });
      const canvas = document.createElement('canvas');
      let { width:w, height:h } = img;
      const scale = Math.min(1, maxDim/Math.max(w,h));
      w = Math.round(w*scale); h = Math.round(h*scale);
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      let q = qualityStart, data;
      for (let i=0;i<3;i++){
        data = canvas.toDataURL('image/jpeg', q);
        const kb = Math.ceil((data.length*3/4)/1024);
        if (kb <= 800) break; q -= 0.15;
      }
      URL.revokeObjectURL(imgURL);
      return { dataURL: data, width:w, height:h, sizeKB: Math.ceil((data.length*3/4)/1024) };
    }

    // ìƒíƒœ
    const GAME_KEYS = ['reaction','aim','mole','math','typing','stroop','simon','rhythm'];
    const STATE = {
      player: load('giftArcade_player') || { id: uid(), nickname:'' },
      device: load('giftArcade_device') || { id: uid(), lockedNick:'' },
      room: load('giftArcade_room') || { code:'', startAt:null, endAt:null, status:'waiting', isHost:false, hostId:null, gameKey:'reaction', limitPerGame:0 },
      scores: load('giftArcade_scores') || { reaction:{best:0}, aim:{best:0, acc:0}, mole:{best:0}, math:{best:0}, typing:{best:0}, stroop:{best:0}, simon:{best:0, round:0}, rhythm:{best:0} },
      attempts: load('giftArcade_attempts') || { byRoom:{} },
      prizes: load('giftArcade_prizes') || { local:{}, remote:{} },
      connected: false
    };

    // ê³µí†µ
    function gameName(k){
      return { reaction:'ë°˜ì‘ì†ë„', aim:'ì—ì„', mole:'ë‘ë”ì§€', math:'ìˆ˜í•™', typing:'íƒ€ì', stroop:'ìŠ¤ë£¨í”„', simon:'íŒ¨í„´ ë©”ëª¨ë¦¬', rhythm:'ë¦¬ë“¬' }[k] || k;
    }
    function getRoomKey(){ return STATE.room.code || 'DEMO' }
    function scoreForGame(scores, key){ return (scores?.[key]?.best)||0 }
    function detailForPlayer(p){
      const k = STATE.room.gameKey;
      const s = p.scores?.[k] || {};
      switch(k){
        case 'reaction': return s.avg? `í‰ê·  ${s.avg}ms` : '-';
        case 'aim': return (s.acc!=null)? `${s.hits||0}ëª…ì¤‘ ${s.acc}%` : '-';
        case 'mole': return (s.acc!=null)? `${s.hits||0}ëª…ì¤‘` : '-';
        case 'math': return `ì •ë‹µ${s.ok||0} ì—°ì†${s.streak||0}`;
        case 'typing': return `${s.words||0}ë‹¨ì–´ ${s.acc||0}%`;
        case 'stroop': return `ì •ë‹µ${s.ok||0} ${s.acc||0}%`;
        case 'simon': return `ë¼ìš´ë“œ ${s.round||s.best||0}`;
        case 'rhythm': return `${s.perfect||0}P/${s.great||0}G`;
        default: return '-';
      }
    }

    // í—¤ë”/ì´ˆê¸°ê°’
    function syncHeader(){
      $('#roomCodeBadge').textContent = STATE.room.code || '-';
      $('#selfBadge').textContent = STATE.player.nickname? `${STATE.player.nickname}${STATE.room.isHost?' (ë°©ì¥)':''}` : '-';
      $('#gameBadge').textContent = gameName(STATE.room.gameKey||'-');
      $('#limitBadge').textContent = STATE.room.limitPerGame ? `${STATE.room.limitPerGame}íšŒ` : 'ë¬´ì œí•œ';
      $('#hostBtn').style.display = STATE.room.isHost ? 'inline-flex' : 'none';
    }
    function saveAll(){
      save('giftArcade_player', STATE.player);
      save('giftArcade_device', STATE.device);
      save('giftArcade_room', STATE.room);
      save('giftArcade_scores', STATE.scores);
      save('giftArcade_attempts', STATE.attempts);
      save('giftArcade_prizes', STATE.prizes);
      syncHeader(); renderLeaderboard(); filterGameView(); updateBestBadges(); updateAttemptBadges();
    }
    $('#nickInput').value = STATE.player.nickname || '';
    $('#roomInput').value = STATE.room.code || (new URLSearchParams(location.search).get('room') || '');
    $('#createGameSelect').value = STATE.room.gameKey || 'reaction';
    syncHeader();

    // ì¹´ìš´íŠ¸ë‹¤ìš´
    let countdownTimer=null;
    function updateCountdown(){
      const n = Date.now();
      if (!STATE.room.startAt || !STATE.room.endAt){ $('#countdown').textContent='--:--'; return; }
      if (n < STATE.room.startAt){
        const s = Math.max(0, Math.floor((STATE.room.startAt - n)/1000));
        $('#countdown').textContent = `ëŒ€ê¸° ${pad(Math.floor(s/60))}:${pad(s%60)}`;
        STATE.room.status='waiting';
      } else if (n < STATE.room.endAt){
        const s = Math.floor((STATE.room.endAt - n)/1000);
        $('#countdown').textContent = `${pad(Math.floor(s/60))}:${pad(s%60)}`;
        STATE.room.status='live';
      } else {
        $('#countdown').textContent='ì¢…ë£Œ';
        if (STATE.room.status!=='ended'){
          STATE.room.status='ended';
          onRoundEnded();
        }
      }
    }
    function startCountdownLoop(){ if (countdownTimer) clearInterval(countdownTimer); countdownTimer=setInterval(updateCountdown, 1000); updateCountdown(); }

    // ë‹‰ë„¤ì„ ê¸°ê¸° ì ê¸ˆ
    function enforceDeviceNick(nick){
      if (!STATE.device.lockedNick){ STATE.device.lockedNick = nick; return true; }
      if (STATE.device.lockedNick && STATE.device.lockedNick !== nick){
        toast(`ì´ ê¸°ê¸°ëŠ” '${STATE.device.lockedNick}'ë§Œ ì‚¬ìš© ê°€ëŠ¥`);
        $('#nickInput').value = STATE.device.lockedNick; // ìë™ìœ¼ë¡œ ê¸°ì¡´ ë‹‰ë„¤ì„ ì„¤ì •
        return false;
      }
      return true;
    }

    // ë°©/ì°¸ì—¬
    function genRoomCode(){ const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<6;i++) s+=c[rnd(0,c.length-1)]; return s }
    async function joinRoom(autoJoin = false){
      const nick = $('#nickInput').value.trim() || STATE.device.lockedNick || '';
      const code = ($('#roomInput').value||'').trim().toUpperCase();
      
      // ìë™ ì…ì¥ ì‹œ ë‹‰ë„¤ì„ì´ ì—†ìœ¼ë©´ í”„ë¡¬í”„íŠ¸
      if (autoJoin && !nick) {
        const inputNick = prompt('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë³„ë¹›í† ë¼)');
        if (!inputNick) return;
        $('#nickInput').value = inputNick.trim();
        return joinRoom(false);
      }
      
      if (!nick) return toast('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”');
      if (!code || code.length<3) return toast('ë°©ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”');
      if (!enforceDeviceNick(nick)) {
        $('#nickInput').value = STATE.device.lockedNick;
        return joinRoom(autoJoin);
      }
      STATE.player.nickname = nick;
      STATE.room.code = code; STATE.room.isHost = false;
      saveAll();
      enterLobby();
      try{
        await firebaseAPI.ensureJoin(false);
      }catch(e){
        console.warn('join fallback offline', e);
      }
    }

    // ìƒì„± ì‹œ ì„ì‹œ ê²½í’ˆ
    const CREATE_PRIZES = { '1':null, '2':null, '3':null };
    async function handleCreatePrize(rank, file, nameInputId, prevId){
      if (!file) return;
      const { dataURL, width, height, sizeKB } = await compressImage(file);
      const name = $(nameInputId).value.trim() || `${rank}ë“± ê²½í’ˆ`;
      CREATE_PRIZES[rank] = { image:dataURL, name, width, height, sizeKB };
      const box = $(prevId); box.innerHTML = '';
      const card = document.createElement('div'); card.className='prize-card';
      card.innerHTML = `<img class="thumb" src="${dataURL}" alt="${rank}ë“±"><div class="meta"><span class="k">${name}</span><span class="sp"></span><span class="tag">${sizeKB}KB</span></div>`;
      box.append(card);
      toast(`${rank}ë“± ê²½í’ˆ ì¤€ë¹„ì™„ë£Œ`);
    }
    $('#createPrizeFile1').addEventListener('change', e=> handleCreatePrize('1', e.target.files?.[0], '#createPrizeName1', '#createPrizePrev1'));
    $('#createPrizeFile2').addEventListener('change', e=> handleCreatePrize('2', e.target.files?.[0], '#createPrizeName2', '#createPrizePrev2'));
    $('#createPrizeFile3').addEventListener('change', e=> handleCreatePrize('3', e.target.files?.[0], '#createPrizeName3', '#createPrizePrev3'));
    
    // ê²½í’ˆëª… ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
    $('#createPrizeName1').addEventListener('input', e=> { if(CREATE_PRIZES['1']) CREATE_PRIZES['1'].name = e.target.value.trim() || '1ë“± ê²½í’ˆ'; });
    $('#createPrizeName2').addEventListener('input', e=> { if(CREATE_PRIZES['2']) CREATE_PRIZES['2'].name = e.target.value.trim() || '2ë“± ê²½í’ˆ'; });
    $('#createPrizeName3').addEventListener('input', e=> { if(CREATE_PRIZES['3']) CREATE_PRIZES['3'].name = e.target.value.trim() || '3ë“± ê²½í’ˆ'; });

    async function createRoom(){
      const minutes = parseInt($('#durationSel').value,10) || 10;
      const code = genRoomCode();
      const t = Date.now();
      const chosen = $('#createGameSelect').value;
      const limit = parseInt($('#createAttemptLimit').value||'0',10) || 0;
      if (!$('#nickInput').value.trim()){ $('#nickInput').value = 'ë°©ì¥'; }
      const nick = $('#nickInput').value.trim();
      if (!enforceDeviceNick(nick)) return;
      STATE.player.nickname = nick;
      STATE.room.code = code;
      STATE.room.isHost = true;
      STATE.room.hostId = STATE.player.id;
      STATE.room.gameKey = chosen;
      STATE.room.limitPerGame = limit;
      STATE.room.startAt = t + 5000;
      STATE.room.endAt = STATE.room.startAt + minutes*60*1000;
      
      // ê²½í’ˆ ì €ì¥ (ì´ë¦„ í¬í•¨)
      for (const r of ['1','2','3']){
        if (CREATE_PRIZES[r]) {
          const nameInput = $(`#createPrizeName${r}`).value.trim();
          if (nameInput) CREATE_PRIZES[r].name = nameInput;
          STATE.prizes.local[r] = CREATE_PRIZES[r];
        }
      }
      
      saveAll();
      enterLobby();
      try{
        await firebaseAPI.ensureJoin(true);
        await firebaseAPI.pushRoomMeta();
        if (Object.keys(STATE.prizes.local).length) await firebaseAPI.pushPrizes();
      }catch(e){
        console.warn('createRoom: Firebase offline', e);
      }
      toast('ìƒˆ ë°© ìƒì„± ì™„ë£Œ!');
    }

    function enterLobby(){
      $('#joinSection').classList.add('hidden');
      $('#lobbySection').classList.remove('hidden');
      $('#winnerSection').classList.add('hidden');
      syncHeader(); startCountdownLoop(); renderLeaderboard(); updateBestBadges(); filterGameView(); updateAttemptBadges();
    }
    
    async function leaveRoom(){
      if (!STATE.room.code){ $('#joinSection').classList.remove('hidden'); $('#lobbySection').classList.add('hidden'); $('#winnerSection').classList.add('hidden'); return; }
      if (!confirm('ê²Œì„ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      await firebaseAPI.disconnect();
      const keepNick = STATE.player.nickname;
      const keepDevice = STATE.device;
      STATE.room = { code:'', startAt:null, endAt:null, status:'waiting', isHost:false, hostId:null, gameKey:'reaction', limitPerGame:0 };
      STATE.player.nickname = keepNick;
      STATE.device = keepDevice;
      saveAll();
      history.replaceState(null, '', location.pathname);
      $('#joinSection').classList.remove('hidden');
      $('#lobbySection').classList.add('hidden');
      $('#winnerSection').classList.add('hidden');
      toast('ë©”ì¸ìœ¼ë¡œ ì´ë™');
    }
    $('#leaveBtn').addEventListener('click', leaveRoom);
    $('#backToMainBtn')?.addEventListener('click', leaveRoom);

    // ê²Œì„ ê°€ì‹œì„±
    function filterGameView(){
      const k = STATE.room.gameKey || 'reaction';

      $$('.game-card').forEach(card=>{
        const show = card.dataset.game === k;
        card.style.display = show ? '' : 'none';
        card.classList.toggle('game-disabled', card.dataset.game !== k);
      });
      $('#gameBadge').textContent = gameName(k);
    }

    // ë¦¬ë”ë³´ë“œ
    let LAST_PLAYERS = [];
    function renderLeaderboard(players){
      const tbody = $('#leaderBody'); tbody.innerHTML='';
      let list = players || LAST_PLAYERS || [];
      if (!players){
        list = [{
          id: STATE.player.id, nickname: STATE.player.nickname||'(ë‚˜)',
          scores: STATE.scores, score: scoreForGame(STATE.scores, STATE.room.gameKey), updatedAt: Date.now()
        }];
      }
      list = list.map(p=> ({ ...p, score: (p.score!=null)? p.score : scoreForGame(p.scores, STATE.room.gameKey) }));
      list.sort((a,b)=> (b.score||0) - (a.score||0) || (a.updatedAt||0) - (b.updatedAt||0));
      list.slice(0,50).forEach((p,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i<3? `<b>${i+1}</b>` : i+1}</td>
          <td>${p.nickname || 'ìµëª…'}</td>
          <td><b>${fmt(Math.round(p.score||0))}</b></td>
          <td class="k">${detailForPlayer(p)}</td>
        `;
        tbody.appendChild(tr);
      });
      $('#lbStatus').textContent = STATE.connected ? 'ì‹¤ì‹œê°„' : 'ì˜¤í”„ë¼ì¸';
    }
    
    function updateBestBadges(){
      $('#reactionBest').textContent = STATE.scores.reaction.best || '-';
      $('#aimBest').textContent = STATE.scores.aim.best || '-';
      $('#aimAcc').textContent = STATE.scores.aim.acc ? `${STATE.scores.aim.acc}%` : '-';
      $('#moleBest').textContent = STATE.scores.mole.best || '-';
      $('#mathBest').textContent = STATE.scores.math.best || '-';
      $('#typingBest').textContent = STATE.scores.typing?.best || '-';
      $('#stroopBest').textContent = STATE.scores.stroop?.best || '-';
      $('#simonBest').textContent = STATE.scores.simon?.best || '-';
      $('#rhythmBest').textContent = STATE.scores.rhythm?.best || '-';
      $('#simonBestRound').textContent = STATE.scores.simon?.round || 0;
    }

    // ì‹œë„ ì œí•œ
    function getAttemptLimit(){ return STATE.room.limitPerGame || 0 }
    function attemptsUsed(gameKey){
      const room = getRoomKey();
      STATE.attempts.byRoom[room] = STATE.attempts.byRoom[room] || {};
      return STATE.attempts.byRoom[room][gameKey] || 0;
    }
    function incAttempt(gameKey){
      const room = getRoomKey();
      STATE.attempts.byRoom[room] = STATE.attempts.byRoom[room] || {};
      STATE.attempts.byRoom[room][gameKey] = (STATE.attempts.byRoom[room][gameKey] || 0) + 1;
      saveAll();
      updateAttemptBadges();
    }
    function canStartGame(gameKey){
      if ((STATE.room.gameKey||'reaction') !== gameKey){ toast('ë‹¤ë¥¸ ê²Œì„ ì§„í–‰ ì¤‘'); return false; }
      if (STATE.room.status === 'ended'){ toast('ë¼ìš´ë“œ ì¢…ë£Œë¨'); return false; }
      const lim = getAttemptLimit();
      if (lim>0 && attemptsUsed(gameKey) >= lim){ toast('ì‹œë„ ì œí•œ ë„ë‹¬'); return false; }
      return true;
    }
    function updateAttemptBadges(){
      const lim = getAttemptLimit();
      for(const k of GAME_KEYS){
        const used = attemptsUsed(k);
        const el = $(`#attemptBad_${k}`); if (!el) continue;
        el.textContent = (STATE.room.gameKey===k) ? (lim ? `${used}/${lim}` : 'ë¬´ì œí•œ') : 'ë¹„í™œì„±';
      }
      $('#limitBadge').textContent = lim? `${lim}íšŒ`:'ë¬´ì œí•œ';
    }

    // ì ìˆ˜ ì œì¶œ
    async function submitScore(gameKey, normalized, extra={}){
      if (STATE.room.gameKey !== gameKey) return;
      if ((STATE.scores[gameKey]?.best||0) < normalized){
        STATE.scores[gameKey] = { best: normalized, ...extra };
        saveAll();
        await firebaseAPI.pushScore();
        renderLeaderboard();
      } else {
        await firebaseAPI.pushScore(true);
      }
    }

    // ê²Œì„ ë¡œì§ì€ ì´ì „ê³¼ ë™ì¼ (ìƒëµ)
    // ... [ëª¨ë“  ê²Œì„ ë¡œì§ ì½”ë“œëŠ” ì´ì „ê³¼ ë™ì¼]

    // ê³µìœ  (ê²½í’ˆëª…ê³¼ ì¢…ë£Œ ì‹œê°„ í¬í•¨)
    function roomURL(){
      const u = new URL(location.href); u.searchParams.set('room', STATE.room.code || ''); return u.toString();
    }
    
    function formatEndTime(){
      if (!STATE.room.endAt) return '';
      const d = new Date(STATE.room.endAt);
      const month = d.getMonth() + 1;
      const date = d.getDate();
      const hour = d.getHours();
      const min = pad(d.getMinutes());
      return `${month}/${date} ${hour}:${min}`;
    }
    
    async function shareText(title, text, url){
      if (navigator.share){
        try{ await navigator.share({ title, text, url }); return true; }catch(e){/* user cancel */ }
      }
      await copy(`${title}\n${text}\n${url}`); return false;
    }
    
    function getPrizeShareText(){
      const prizes = { ...STATE.prizes.local, ...STATE.prizes.remote };
      const prizeNames = [];
      if (prizes['1']?.name) prizeNames.push(`ğŸ¥‡ ${prizes['1'].name}`);
      if (prizes['2']?.name) prizeNames.push(`ğŸ¥ˆ ${prizes['2'].name}`);
      if (prizes['3']?.name) prizeNames.push(`ğŸ¥‰ ${prizes['3'].name}`);
      
      const endTime = formatEndTime();
      const timeText = endTime ? `\nâ° ì¢…ë£Œ: ${endTime}` : '';
      
      if (prizeNames.length > 0){
        return `ğŸ ê¸°í”„í‹°ì½˜ ë°°í‹€ ì•„ì¼€ì´ë“œ\n\nê²½í’ˆ:\n${prizeNames.join('\n')}\n\nğŸ“ ë°©ì½”ë“œ: ${STATE.room.code}\nğŸ® ${gameName(STATE.room.gameKey)} ê²Œì„${timeText}`;
      } else {
        return `ğŸ® ê¸°í”„í‹°ì½˜ ë°°í‹€ ì•„ì¼€ì´ë“œ\nğŸ“ ë°©ì½”ë“œ: ${STATE.room.code}\nğŸ¯ ${gameName(STATE.room.gameKey)} ê²Œì„ìœ¼ë¡œ ì‹¤ì‹œê°„ ê²½ìŸ!${timeText}`;
      }
    }
    
    $('#shareBtn').addEventListener('click', ()=>{ if (!STATE.room.code) return toast('ë°©ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤'); shareText('ê¸°í”„í‹°ì½˜ ë°°í‹€ ì•„ì¼€ì´ë“œ', getPrizeShareText(), roomURL()); });
    $('#shareLinkBtn').addEventListener('click', ()=>{ 
      if (!STATE.room.code) return toast('ë°©ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤'); 
      shareText('ê¸°í”„í‹°ì½˜ ë°°í‹€ ì•„ì¼€ì´ë“œ', getPrizeShareText(), roomURL()); 
    });

    // ì¼ë°˜ ë²„íŠ¼
    $('#joinBtn').addEventListener('click', ()=> joinRoom(false));
    $('#createRoomBtn').addEventListener('click', createRoom);
    $('#copyRoom').addEventListener('click', ()=> STATE.room.code? copy(STATE.room.code) : toast('ë°©ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤'));
    $('#refreshBtn').addEventListener('click', ()=> firebaseAPI.refresh());

    // Firebase API (ì´ì „ê³¼ ë™ì¼, ìƒëµ)
    const firebaseAPI = {
      // ... [Firebase API ì½”ë“œëŠ” ì´ì „ê³¼ ë™ì¼]
    };

    // URLì—ì„œ ë°©ì½”ë“œ ë°˜ì˜ ë° ìë™ ì…ì¥
    (async function initFromURL(){
      const roomParam = new URLSearchParams(location.search).get('room');
      if (roomParam){
        $('#roomInput').value = roomParam.toUpperCase();
        STATE.room.code = roomParam.toUpperCase();
        
        // ì´ˆëŒ€ë§í¬ë¡œ ì…ì¥ ì‹œ ìë™ ì…ì¥
        if (!STATE.player.nickname || STATE.player.nickname !== STATE.device.lockedNick){
          // ë‹‰ë„¤ì„ì´ ì—†ê±°ë‚˜ ê¸°ê¸° ì ê¸ˆ ë‹‰ë„¤ì„ê³¼ ë‹¤ë¥´ë©´
          if (STATE.device.lockedNick){
            // ê¸°ê¸° ì ê¸ˆ ë‹‰ë„¤ì„ì´ ìˆìœ¼ë©´ ìë™ ì‚¬ìš©
            $('#nickInput').value = STATE.device.lockedNick;
            await joinRoom(true);
          } else {
            // ë‹‰ë„¤ì„ ì…ë ¥ í•„ìš”
            setTimeout(()=> {
              const nick = prompt('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë³„ë¹›í† ë¼)');
              if (nick){
                $('#nickInput').value = nick.trim();
                joinRoom(true);
              }
            }, 500);
          }
        } else {
          // ì´ë¯¸ ë‹‰ë„¤ì„ì´ ìˆìœ¼ë©´ ë°”ë¡œ ì…ì¥
          await joinRoom(true);
        }
      } else if (STATE.room.code && STATE.player.nickname){
        // URLì— ë°©ì½”ë“œê°€ ì—†ì§€ë§Œ ì €ì¥ëœ ì •ë³´ê°€ ìˆìœ¼ë©´
        enterLobby();
        try{ await firebaseAPI.ensureJoin(STATE.room.isHost); }catch{}
      }
      
      startCountdownLoop();
    })();

  </script>
</body>
</html>
