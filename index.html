<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>기프티콘 배틀 아케이드 · 실시간 순위 · 등수별 경품</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg: #0e0f12;
      --card: #14161a;
      --muted: #8f9bb3;
      --text: #e7eaf3;
      --acc: #6ae3ff;
      --acc2:#7cf2b5;
      --warn:#ff9c6e;
      --err:#ff6b7a;
      --good:#86f28e;
      --glass: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent; -webkit-user-select: none; user-select: none;}
    input, textarea { -webkit-user-select: text; user-select: text; }
    html,body{height:100%; touch-action: pan-y; overflow-x: hidden;}
    body{
      margin:0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 10% -10%, #1a1d24 0, transparent 60%),
        radial-gradient(1000px 600px at 110% 10%, #141922 0, transparent 60%),
        linear-gradient(180deg, #0b0c0f, #0f1116 40%, #0e0f12);
      min-height:100%;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    /* 확대 방지 추가 */
    input:focus, select:focus, textarea:focus, button:focus {
      font-size: 16px !important;
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px }
    header{
      position:sticky; top:0; z-index:8;
      background:linear-gradient(180deg, rgba(10,11,14,.9), rgba(10,11,14,.65) 70%, transparent);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      border-bottom:1px solid var(--border);
    }
    .bar{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:10px 16px; flex-wrap:wrap }
    .logo{display:flex; gap:8px; align-items:center; font-weight:800; letter-spacing:.2px}
    .logo .mark{
      width:24px; height:24px; border-radius:8px; display:grid; place-items:center;
      background: conic-gradient(from 210deg, #3be7f7, #7cf2b5, #87b2ff);
      box-shadow: inset 0 0 0 3px rgba(0,0,0,.25), 0 8px 22px rgba(58, 228, 255, .25);
      color:#0b0c0f; font-weight:900; font-size:14px;
    }
    .logo .hint{font-size:11px}
    .pill{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--glass); color:var(--text); font-weight:600; font-size:13px}
    .pill code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.95em}
    .btn{
      appearance:none; border:1px solid var(--border); background:var(--glass); color:var(--text);
      padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; font-size:14px;
      transition: .15s transform ease, .2s background ease, .2s border ease, .2s color ease;
      touch-action: manipulation; -webkit-touch-callout: none;
    }
    .btn[disabled]{opacity:.55; cursor:not-allowed}
    .btn:active{transform: scale(0.98); filter: brightness(1.2)}
    .btn:hover{transform: translateY(-1px); border-color:#3ae5ff44; background: rgba(122,240,255,.08)}
    .btn.acc{ background: linear-gradient(180deg, #1f3340, #15232b); border-color:#2a8ca955; color:#b8f2ff; box-shadow: inset 0 -4px 18px rgba(82,193,213,.25), 0 10px 24px rgba(46,178,208,.25) }
    .btn.good{ background: linear-gradient(180deg, #1c3523, #12271a); border-color:#2a9d5250; color:#bff5d0; box-shadow: inset 0 -4px 18px rgba(90,205,145,.22), 0 10px 24px rgba(90,205,145,.2) }
    .btn.warn{ background: linear-gradient(180deg, #3b2417, #2a1b12); border-color:#ff9c6e55; color:#ffd8c8 }
    .btn.err{ background: linear-gradient(180deg, #3b1620, #2a1117); border-color:#ff6b7a55; color:#ffd0d6 }
    .grid{display:grid; gap:16px}
    .cols{grid-template-columns: 1.3fr .7fr}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border); border-radius:16px; box-shadow: var(--shadow); padding:16px;
    }
    h1,h2,h3,h4{margin:0 0 8px 0}
    .muted{color:var(--muted)}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .sp{flex:1}
    .field{display:flex; flex-direction:column; gap:8px}
    .field input, .field select, .field textarea{
      background:var(--card); border:1px solid var(--border); color:var(--text);
      border-radius:10px; padding:10px 12px; outline:none; width:100%; font-size:16px;
      touch-action: manipulation; -webkit-appearance: none;
    }
    .hint{font-size:.85em; color:var(--muted)}
    .section{margin-top:16px}
    .badge{display:inline-flex; padding:.2rem .4rem; border-radius:6px; font-weight:800; font-size:.8em; border:1px solid var(--border); background:rgba(255,255,255,.05)}
    .leader{ max-height: 480px; overflow:auto; border-radius:12px; border:1px solid var(--border); background: rgba(255,255,255,.04); -webkit-overflow-scrolling: touch; }
    .leader table{width:100%; border-collapse:collapse; font-variant-numeric: tabular-nums; font-size:13px}
    .leader th, .leader td{padding:8px 10px; border-bottom:1px solid var(--border)}
    .leader tr:hover{background: rgba(255,255,255,.05)}
    .game-area{min-height:380px; border-radius:14px; border:1px dashed #2a2f39; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)); display:grid; place-items:center; position:relative; overflow:hidden; touch-action: none;}
    .center{display:grid; place-items:center; text-align:center; gap:12px; padding:12px}
    .timer{font-variant-numeric: tabular-nums; font-weight:800}
    .big{font-size:24px; font-weight:900}
    .xl{font-size:36px; font-weight:900}
    .hidden{display:none !important}
    .footnote{font-size:.85em; color:var(--muted)}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%); bottom:20px; z-index:1000;
      background:#14161a; border:1px solid var(--border); padding:10px 14px; border-radius:10px; box-shadow: var(--shadow);
      opacity:0; pointer-events:none; transition:.25s opacity ease, .25s transform ease; font-size:14px; max-width:90vw;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-6px)}
    .chip{padding:.2rem .45rem; background:rgba(255,255,255,.06); border:1px solid var(--border); border-radius:999px; font-weight:800; font-size:.8em}
    .tag{display:inline-block; padding:.2rem .45rem; border-radius:6px; border:1px solid var(--border); background:rgba(255,255,255,.05); font-size:.8em}
    .gamegrid{display:grid; grid-template-columns: repeat(2, minmax(280px, 1fr)); gap:12px; width:100%}
    .k{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
    
    /* 경품 프리뷰 */
    .prize-preview{ display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; margin-top:8px }
    .prize-card{ border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#0f1217; width:180px; box-shadow: var(--shadow) }
    .prize-card .thumb{width:100%; aspect-ratio: 1 / 1; object-fit:cover; display:block}
    .prize-card .meta{padding:6px 8px; font-size:.8em; display:flex; gap:6px; align-items:center}
    .overlay{ position:absolute; inset:0; display:grid; place-items:center; background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.6)); color:#fff; font-weight:900 }
    .divider{height:1px; background:var(--border); margin:12px 0}

    /* Mole grid */
    .mole-grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; width:100%; max-width:360px; margin:0 auto; }
    .mole-cell{ aspect-ratio:1/1; border:1px solid #2a2f39; border-radius:10px; background:#0d1216; position:relative; overflow:hidden; cursor:pointer; touch-action: none; }
    .mole{ position:absolute; left:50%; top:100%; transform:translate(-50%, -50%); width:70%; aspect-ratio:1/1; border-radius:50%;
      background:radial-gradient(circle at 50% 60%, #6ae3ff 0, #318ea1 60%, #1b3f47 100%); transition:.12s top ease, .05s filter ease; box-shadow: 0 8px 24px rgba(0,0,0,.35); pointer-events:none; }
    .mole[data-up="1"]{ pointer-events:auto; }

    .game-disabled{ position:relative; opacity:.6 }
    .game-disabled::after{ content:'다른 게임 진행 중'; position:absolute; inset:0; display:grid; place-items:center; font-weight:900; color:#fff; background:rgba(0,0,0,.5); border-radius:14px }
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:999; background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.6)); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); padding:16px }

    /* Rhythm game */
    .rhythm-area{ position:relative; height:420px; width:100%; max-width:640px; background:linear-gradient(180deg, #0c0f14, #0a0d12); border-radius:12px; border:1px dashed #2a2f39; overflow:hidden; touch-action: none; margin:0 auto }
    .lane{ position:absolute; top:0; bottom:0; width:25%; border-left:1px solid #1d2430; border-right:1px solid #1d2430; }
    .lane:nth-child(1){ left:0% } .lane:nth-child(2){ left:25% } .lane:nth-child(3){ left:50% } .lane:nth-child(4){ left:75% }
    .hitline{ position:absolute; left:0; right:0; bottom:54px; height:2px; background:#445; box-shadow:0 0 12px rgba(110,160,255,.4) inset }
    .note{ position:absolute; width:55%; left:22.5%; height:16px; background:linear-gradient(180deg, #9bd1ff, #4fa3ff); border-radius:6px; box-shadow:0 8px 18px rgba(0,0,0,.35) }
    .keyhints{ position:absolute; left:0; right:0; bottom:8px; display:flex; justify-content:space-around; padding:0 16px; color:#9fb3ff; font-weight:900 }
    .keycap{ padding:.3rem .5rem; border:1px solid #2a3658; background:#0e1320; border-radius:6px; min-width:36px; text-align:center; cursor:pointer; touch-action: none; font-size:12px }
    .keycap:active{ filter:brightness(1.4) }

    /* Simon (패턴 메모리) */
    .simon-grid{ display:grid; grid-template-columns: repeat(2, 120px); gap:10px; justify-content:center }
    .simon-pad{ width:120px; height:120px; border-radius:10px; cursor:pointer; box-shadow: inset 0 0 0 2px rgba(255,255,255,.05); touch-action: none; }
    .simon-pad.pad1{ background:#2a3b4a } .simon-pad.pad2{ background:#3a2f49 } .simon-pad.pad3{ background:#2d4a39 } .simon-pad.pad4{ background:#4a2a2a }
    
    /* 모바일 대응 */
    @media (max-width: 980px){
      .cols{grid-template-columns: 1fr}
      .gamegrid{grid-template-columns: 1fr}
      .xl{font-size:28px}
      .big{font-size:20px}
      .bar{padding:8px 12px; gap:6px}
      .logo .mark{width:20px; height:20px; font-size:12px}
      .btn{padding:7px 10px; font-size:13px}
      .pill{padding:5px 8px; font-size:12px}
      .card{padding:12px}
      .game-area{min-height:320px}
      .rhythm-area{height:360px}
      .mole-grid{max-width:300px; gap:6px}
      .simon-grid{grid-template-columns: repeat(2, 100px); gap:8px}
      .simon-pad{width:100px; height:100px}
      .leader{max-height:400px}
      .leader th, .leader td{padding:6px 8px; font-size:12px}
      .prize-card{width:140px}
      h2{font-size:20px} h3{font-size:16px}
    }
    @media (max-width: 480px){
      .wrap{padding:12px}
      .logo .hint{display:none}
      .bar{justify-content:center}
      .game-area{min-height:280px}
      .mole-grid{max-width:260px}
      .rhythm-area{height:320px}
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="logo">
        <div class="mark">G</div>
        <div>
          기프티콘 배틀
          <div class="hint">실시간 순위 · 등수별 경품</div>
        </div>
      </div>
      <div class="row">
        <div class="pill"><span>방</span> <code id="roomCodeBadge">-</code> <button id="copyRoom" class="btn">복사</button></div>
        <div class="pill"><span>남은</span> <span class="timer" id="countdown">--:--</span></div>
        <button id="shareLinkBtn" class="btn" title="방 링크 공유">공유</button>
        <button id="hostBtn" class="btn" title="방장 설정">방장</button>
        <button id="leaveBtn" class="btn warn" title="나가기">나가기</button>
      </div>
    </div>
  </header>

  <div class="wrap grid cols">
    <main class="card">
      <!-- 메인(입장/생성) -->
      <div id="joinSection" class="section">
        <h2>시작하기</h2>
        <div class="hint">방을 만들 때 한 가지 게임만 선택해 경쟁합니다. 라운드 종료 후 등수별 경품을 자동 제공할 수 있어요.</div>
        <div class="section grid" style="grid-template-columns:1fr 1fr">
          <!-- 참여 -->
          <div class="card">
            <h3>방 참여</h3>
            <div class="field">
              <label>닉네임</label>
              <input id="nickInput" placeholder="예: 별빛토끼" maxlength="16">
              <div class="hint">이 기기에서는 한 닉네임만 사용 가능</div>
            </div>
            <div class="field">
              <label>방코드</label>
              <input id="roomInput" placeholder="예: ABC123" maxlength="16">
              <div class="hint">초대 링크의 방코드 자동 입력</div>
            </div>
            <div class="row">
              <button id="joinBtn" class="btn acc">방 참여</button>
            </div>
          </div>

          <!-- 생성(방장) -->
          <div class="card">
            <h3>새로운 방 만들기</h3>
            <div class="field">
              <label>경쟁 게임 선택</label>
              <select id="createGameSelect">
                <option value="reaction">반응속도 챌린지</option>
                <option value="aim">에임 트레이너</option>
                <option value="mole">두더지 잡기</option>
                <option value="math">수학 러시</option>
                <option value="typing">타자 스프린트</option>
                <option value="stroop">색상 스루프</option>
                <option value="simon">패턴 메모리</option>
                <option value="rhythm">리듬 마스터</option>
              </select>
            </div>
            <div class="field">
              <label>라운드 시간</label>
              <select id="durationSel">
                <option value="5">5분</option>
                <option value="10" selected>10분</option>
                <option value="15">15분</option>
                <option value="20">20분</option>
              </select>
            </div>
            <div class="field">
              <label>시도 제한(0=무제한)</label>
              <input id="createAttemptLimit" type="number" min="0" value="0">
            </div>

            <div class="section">
              <h4>등수별 경품</h4>
              <div class="hint">이미지를 첨부하세요. 해당 등수만 받을 수 있습니다</div>
              <div class="grid" style="grid-template-columns:1fr">
                <div class="field">
                  <label>1등 경품</label>
                  <input type="file" id="createPrizeFile1" accept="image/*">
                  <input id="createPrizeName1" placeholder="예: 스타벅스 아메리카노">
                  <div id="createPrizePrev1" class="prize-preview"></div>
                </div>
                <div class="field">
                  <label>2등 경품</label>
                  <input type="file" id="createPrizeFile2" accept="image/*">
                  <input id="createPrizeName2" placeholder="예: 베스킨라빈스 파인트">
                  <div id="createPrizePrev2" class="prize-preview"></div>
                </div>
                <div class="field">
                  <label>3등 경품</label>
                  <input type="file" id="createPrizeFile3" accept="image/*">
                  <input id="createPrizeName3" placeholder="예: 편의점 3천원권">
                  <div id="createPrizePrev3" class="prize-preview"></div>
                </div>
              </div>
            </div>

            <div class="row">
              <button id="createRoomBtn" class="btn good">새 방 생성</button>
              <span class="hint">5초 후 시작</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 로비/게임 -->
      <div id="lobbySection" class="section hidden">
        <div class="row">
          <h2>게임</h2>
          <span class="chip" id="selfBadge">-</span>
          <span class="chip" id="gameBadge">-</span>
          <span class="chip" id="limitBadge">-</span>
          <div class="sp"></div>
          <button id="shareBtn" class="btn">초대</button>
        </div>
        <div class="hint">선택된 게임으로 경쟁합니다. 종료 시 등수별 경품 제공!</div>

        <div class="section gamegrid" id="gameGrid">
          <!-- Reaction -->
          <div class="card game-card" data-game="reaction">
            <div class="row"><h3>반응속도</h3><span class="badge">3 라운드</span><span class="sp"></span><span class="badge" id="attemptBad_reaction">-</span></div>
            <div class="hint">녹색 신호 후 클릭! 평균 ms가 낮을수록 고득점</div>
            <div class="game-area" id="reactionArea">
              <div class="center">
                <div class="xl">준비!</div>
                <div class="hint">3회 측정</div>
                <button class="btn acc" id="reactionStart">시작</button>
              </div>
            </div>
            <div class="row section">
              <div class="badge">최고: <span id="reactionBest">-</span></div>
            </div>
          </div>

          <!-- Aim -->
          <div class="card game-card" data-game="aim">
            <div class="row"><h3>에임</h3><span class="badge">30초</span><span class="sp"></span><span class="badge" id="attemptBad_aim">-</span></div>
            <div class="hint">타겟 클릭! 명중/정확도로 점수</div>
            <div class="game-area" id="aimArea" style="height:320px; position:relative">
              <div class="center">
                <div class="xl">에임</div>
                <button class="btn acc" id="aimStart">시작</button>
              </div>
            </div>
            <div class="row section">
              <div class="badge">최고: <span id="aimBest">-</span></div>
              <div class="badge">정확도: <span id="aimAcc">-</span></div>
            </div>
          </div>

          <!-- Mole -->
          <div class="card game-card" data-game="mole">
            <div class="row"><h3>두더지</h3><span class="badge">30초</span><span class="sp"></span><span class="badge" id="attemptBad_mole">-</span></div>
            <div class="hint">두더지 클릭! 빈 칸 클릭 감점</div>
            <div class="game-area" id="moleArea">
              <div class="center" style="width:100%">
                <div class="mole-grid" id="moleGrid"></div>
                <div class="row" style="margin-top:8px">
                  <button class="btn acc" id="moleStart">시작</button>
                  <div class="sp"></div>
                  <div class="badge">명중: <span id="moleHits">0</span></div>
                  <div class="badge">오클릭: <span id="moleMiss">0</span></div>
                  <div class="badge"><span id="moleTime">--</span>s</div>
                </div>
              </div>
            </div>
            <div class="row section">
              <div class="badge">최고: <span id="moleBest">-</span></div>
            </div>
          </div>

          <!-- Math -->
          <div class="card game-card" data-game="math">
            <div class="row"><h3>수학</h3><span class="badge">60초</span><span class="sp"></span><span class="badge" id="attemptBad_math">-</span></div>
            <div class="hint">빠르게 풀수록 고득점</div>
            <div class="game-area" id="mathArea">
              <div class="center">
                <div class="big" id="mathQ">3 + 4 × 2 = ?</div>
                <div class="row">
                  <input id="mathAns" class="k" style="width:180px; font-size:16px" placeholder="정답" inputmode="numeric" />
                  <button class="btn acc" id="mathStart">시작</button>
                </div>
                <div class="row" style="gap:6px">
                  <div class="badge">정답: <span id="mathOk">0</span></div>
                  <div class="badge">연속: <span id="mathStreak">0</span></div>
                  <div class="badge"><span id="mathTime">--</span>s</div>
                </div>
              </div>
            </div>
            <div class="row section">
              <div class="badge">최고: <span id="mathBest">-</span></div>
            </div>
          </div>

          <!-- Typing -->
          <div class="card game-card" data-game="typing">
            <div class="row"><h3>타자</h3><span class="badge">20초</span><span class="sp"></span><span class="badge" id="attemptBad_typing">-</span></div>
            <div class="hint">단어를 빠르고 정확하게!</div>
            <div class="game-area" id="typingArea">
              <div class="center">
                <div class="big" id="typingWord">ready</div>
                <input id="typingInput" class="k" style="width:200px; font-size:16px" placeholder="입력 후 Enter" disabled />
                <div class="row">
                                    <button class="btn acc" id="typingStart">시작</button>
                  <div class="sp"></div>
                  <div class="badge">완료: <span id="typingOk">0</span></div>
                  <div class="badge"><span id="typingAcc">0%</span></div>
                  <div class="badge"><span id="typingTime">--</span>s</div>
                </div>
              </div>
            </div>
            <div class="row section">
              <div class="badge">최고: <span id="typingBest">-</span></div>
            </div>
          </div>

          <!-- Stroop -->
          <div class="card game-card" data-game="stroop">
            <div class="row"><h3>스루프</h3><span class="badge">30초</span><span class="sp"></span><span class="badge" id="attemptBad_stroop">-</span></div>
            <div class="hint">글자 색에 맞는 버튼 클릭!</div>
            <div class="game-area" id="stroopArea" style="min-height:320px">
              <div class="center">
                <div class="xl" id="stroopWord">BLUE</div>
                <div class="row" id="stroopBtns"></div>
                <div class="row">
                  <button class="btn acc" id="stroopStart">시작</button>
                  <div class="sp"></div>
                  <div class="badge">정답: <span id="stroopOk">0</span></div>
                  <div class="badge">오답: <span id="stroopWrong">0</span></div>
                  <div class="badge"><span id="stroopTime">--</span>s</div>
                </div>
              </div>
            </div>
            <div class="row section">
              <div class="badge">최고: <span id="stroopBest">-</span></div>
            </div>
          </div>

          <!-- Simon -->
          <div class="card game-card" data-game="simon">
            <div class="row"><h3>패턴 메모리</h3><span class="badge">무제한</span><span class="sp"></span><span class="badge" id="attemptBad_simon">-</span></div>
            <div class="hint">빛나는 순서 기억 후 클릭!</div>
            <div class="game-area" id="simonArea" style="min-height:320px">
              <div class="center">
                <div class="simon-grid">
                  <div class="simon-pad pad1" id="simonPad1"></div>
                  <div class="simon-pad pad2" id="simonPad2"></div>
                  <div class="simon-pad pad3" id="simonPad3"></div>
                  <div class="simon-pad pad4" id="simonPad4"></div>
                </div>
                <div class="row">
                  <button class="btn acc" id="simonStart">시작</button>
                  <div class="sp"></div>
                  <div class="badge">라운드: <span id="simonRound">0</span></div>
                  <div class="badge">최고: <span id="simonBestRound">0</span></div>
                </div>
              </div>
            </div>
            <div class="row section">
              <div class="badge">최고: <span id="simonBest">-</span></div>
            </div>
          </div>

          <!-- Rhythm -->
          <div class="card game-card" data-game="rhythm">
            <div class="row"><h3>리듬</h3><span class="badge">약 40초</span><span class="sp"></span><span class="badge" id="attemptBad_rhythm">-</span></div>
            <div class="hint">D F J K 키 또는 아래 버튼 터치!</div>
            <div class="game-area" id="rhythmArea">
              <div class="center" style="width:100%">
                <div class="rhythm-area" id="rhythmStage">
                  <div class="lane"></div><div class="lane"></div><div class="lane"></div><div class="lane"></div>
                  <div class="hitline"></div>
                  <div class="keyhints">
                    <div class="keycap" data-lane="0">D</div>
                    <div class="keycap" data-lane="1">F</div>
                    <div class="keycap" data-lane="2">J</div>
                    <div class="keycap" data-lane="3">K</div>
                  </div>
                </div>
                <div class="row" style="margin-top:8px">
                  <button class="btn acc" id="rhythmStart">시작</button>
                  <div class="sp"></div>
                  <div class="badge">점수: <span id="rhythmScore">0</span></div>
                  <div class="badge">콤보: <span id="rhythmCombo">0</span></div>
                  <div class="badge"><span id="rhythmAcc">0%</span></div>
                </div>
              </div>
            </div>
            <div class="row section">
              <div class="badge">최고: <span id="rhythmBest">-</span></div>
            </div>
          </div>

        </div>
      </div>

      <!-- 종료/발표 -->
      <div id="winnerSection" class="section hidden">
        <div class="card">
          <div class="row">
            <h2>라운드 종료</h2>
            <span class="badge">순위 발표</span>
            <div class="sp"></div>
            <button class="btn" id="backToMainBtn">메인으로</button>
          </div>
          <div id="winnerBox" class="section">결과 대기 중...</div>
          <div id="prizeBox" class="section hidden">
            <div class="divider"></div>
            <h3>내 경품</h3>
            <div id="prizeContent"></div>
          </div>
        </div>
      </div>
    </main>

    <!-- 순위판 -->
    <aside class="card">
      <div class="row">
        <h3>실시간 순위</h3>
        <span class="tag" id="lbStatus">연결 대기</span>
        <div class="sp"></div>
        <button class="btn" id="refreshBtn">새로고침</button>
      </div>
      <div class="leader section">
        <table>
          <thead>
            <tr>
              <th style="width:40px">#</th>
              <th>닉네임</th>
              <th style="width:80px">점수</th>
              <th style="width:160px">세부</th>
            </tr>
          </thead>
          <tbody id="leaderBody"></tbody>
        </table>
      </div>
      <div class="section">
        <div class="footnote">선택된 게임의 최고 기록 기반</div>
      </div>
    </aside>
  </div>

  <!-- 방장 모달 -->
  <div class="modal" id="hostModal" aria-hidden="true">
    <div class="card" style="width:min(920px, 96vw); max-height:90vh; overflow:auto">
      <div class="row">
        <h3>방장 설정</h3>
        <span class="tag" id="hostRoomTag">방 -</span>
        <div class="sp"></div>
        <button class="btn" id="closeHost">닫기</button>
      </div>
      <div class="divider"></div>

      <div class="grid" style="grid-template-columns:1fr">
        <div>
          <h4>방/라운드</h4>
          <div class="field">
            <label>방코드</label>
            <input id="hostRoomCode" readonly>
          </div>
          <div class="row">
            <div class="field" style="flex:1">
              <label>시작 시각</label>
              <input id="hostStartAt" type="datetime-local">
            </div>
            <div class="field" style="flex:1">
              <label>종료 시각</label>
              <input id="hostEndAt" type="datetime-local">
            </div>
          </div>
          <div class="field">
            <label>경쟁 게임</label>
            <select id="hostGameSelect">
              <option value="reaction">반응속도</option>
              <option value="aim">에임</option>
              <option value="mole">두더지</option>
              <option value="math">수학 러시</option>
              <option value="typing">타자</option>
              <option value="stroop">스루프</option>
              <option value="simon">패턴 메모리</option>
              <option value="rhythm">리듬 마스터</option>
            </select>
          </div>
          <div class="field">
            <label>시도 제한(0=무제한)</label>
            <input id="hostAttemptLimit" type="number" min="0" value="0">
          </div>
          <div class="row">
            <button class="btn acc" id="saveHostMeta">설정 저장</button>
            <button class="btn warn" id="hostEndNow">지금 종료</button>
          </div>
        </div>

        <div>
          <h4>등수별 경품</h4>
          <div class="grid" style="grid-template-columns:1fr">
            <div class="field">
              <label>1등 이미지</label>
              <input type="file" id="prizeFile1" accept="image/*">
              <input id="prizeName1" placeholder="1등 경품 이름">
              <div id="prizePreview1" class="prize-preview"></div>
            </div>
            <div class="field">
              <label>2등 이미지</label>
              <input type="file" id="prizeFile2" accept="image/*">
              <input id="prizeName2" placeholder="2등 경품 이름">
              <div id="prizePreview2" class="prize-preview"></div>
            </div>
            <div class="field">
              <label>3등 이미지</label>
              <input type="file" id="prizeFile3" accept="image/*">
              <input id="prizeName3" placeholder="3등 경품 이름">
              <div id="prizePreview3" class="prize-preview"></div>
            </div>
          </div>
          <div class="row">
            <button class="btn good" id="savePrizes">로컬 저장</button>
            <div class="sp"></div>
            <button class="btn acc" id="publishPrizes">방에 배포</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">알림</div>

  <script type="module">
    // 화면 확대 방지
    document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
    document.addEventListener('touchmove', function(e) { 
      if (e.scale !== 1) { e.preventDefault(); }
    }, { passive: false });
    
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyAE0RssQGTXBi8RzrtNe1Le6SymxFmZSjY",
      authDomain: "lucky-b2ad8.firebaseapp.com",
      projectId: "lucky-b2ad8",
      storageBucket: "lucky-b2ad8.firebasestorage.app",
      messagingSenderId: "674619666684",
      appId: "1:674619666684:web:a8252ca2f8f23e40b9e779"
    };

    // 유틸
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const delay = ms => new Promise(r => setTimeout(r, ms));
    const clamp = (n, mi, ma) => Math.max(mi, Math.min(ma, n));
    const rnd = (a,b) => Math.floor(Math.random()*(b-a+1))+a;
    const uid = () => ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c=>(c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
    const now = () => Date.now();
    const fmt = n => new Intl.NumberFormat('ko-KR').format(n);
    const pad = (n,d=2)=> String(n).padStart(d,'0');
    const toast = (t)=>{ const el=$('#toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2500) };
    const copy = async (txt)=>{ try{ await navigator.clipboard.writeText(txt); toast('복사 완료'); }catch(e){ toast('복사 실패') } };
    const load = (k,def=null)=>{ try{ const v = localStorage.getItem(k); return v?JSON.parse(v):def }catch{ return def } }
    const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
    const downloadDataURL = (dataURL, filename='prize.jpg')=>{
      const a=document.createElement('a'); a.href=dataURL; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
    };

    // 이미지 압축
    async function compressImage(file, maxDim=1024, qualityStart=0.8){
      const imgURL = URL.createObjectURL(file);
      const img = new Image(); img.src = imgURL;
      await new Promise(res=> { img.onload = res; img.onerror = res });
      const canvas = document.createElement('canvas');
      let { width:w, height:h } = img;
      const scale = Math.min(1, maxDim/Math.max(w,h));
      w = Math.round(w*scale); h = Math.round(h*scale);
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      let q = qualityStart, data;
      for (let i=0;i<3;i++){
        data = canvas.toDataURL('image/jpeg', q);
        const kb = Math.ceil((data.length*3/4)/1024);
        if (kb <= 800) break; q -= 0.15;
      }
      URL.revokeObjectURL(imgURL);
      return { dataURL: data, width:w, height:h, sizeKB: Math.ceil((data.length*3/4)/1024) };
    }

    // 상태
    const GAME_KEYS = ['reaction','aim','mole','math','typing','stroop','simon','rhythm'];
    const STATE = {
      player: load('giftArcade_player') || { id: uid(), nickname:'' },
      device: load('giftArcade_device') || { id: uid(), lockedNick:'' },
      room: load('giftArcade_room') || { code:'', startAt:null, endAt:null, status:'waiting', isHost:false, hostId:null, gameKey:'reaction', limitPerGame:0 },
      scores: load('giftArcade_scores') || { reaction:{best:0}, aim:{best:0, acc:0}, mole:{best:0}, math:{best:0}, typing:{best:0}, stroop:{best:0}, simon:{best:0, round:0}, rhythm:{best:0} },
      attempts: load('giftArcade_attempts') || { byRoom:{} },
      prizes: load('giftArcade_prizes') || { local:{}, remote:{} },
      connected: false
    };

    // 공통
    function gameName(k){
      return { reaction:'반응속도', aim:'에임', mole:'두더지', math:'수학', typing:'타자', stroop:'스루프', simon:'패턴 메모리', rhythm:'리듬' }[k] || k;
    }
    function getRoomKey(){ return STATE.room.code || 'DEMO' }
    function scoreForGame(scores, key){ return (scores?.[key]?.best)||0 }
    function detailForPlayer(p){
      const k = STATE.room.gameKey;
      const s = p.scores?.[k] || {};
      switch(k){
        case 'reaction': return s.avg? `평균 ${s.avg}ms` : '-';
        case 'aim': return (s.acc!=null)? `${s.hits||0}명중 ${s.acc}%` : '-';
        case 'mole': return (s.acc!=null)? `${s.hits||0}명중` : '-';
        case 'math': return `정답${s.ok||0} 연속${s.streak||0}`;
        case 'typing': return `${s.words||0}단어 ${s.acc||0}%`;
        case 'stroop': return `정답${s.ok||0} ${s.acc||0}%`;
        case 'simon': return `라운드 ${s.round||s.best||0}`;
        case 'rhythm': return `${s.perfect||0}P/${s.great||0}G`;
        default: return '-';
      }
    }

    // 헤더/초기값
    function syncHeader(){
      $('#roomCodeBadge').textContent = STATE.room.code || '-';
      $('#selfBadge').textContent = STATE.player.nickname? `${STATE.player.nickname}${STATE.room.isHost?' (방장)':''}` : '-';
      $('#gameBadge').textContent = gameName(STATE.room.gameKey||'-');
      $('#limitBadge').textContent = STATE.room.limitPerGame ? `${STATE.room.limitPerGame}회` : '무제한';
      $('#hostBtn').style.display = STATE.room.isHost ? 'inline-flex' : 'none';
    }
    function saveAll(){
      save('giftArcade_player', STATE.player);
      save('giftArcade_device', STATE.device);
      save('giftArcade_room', STATE.room);
      save('giftArcade_scores', STATE.scores);
      save('giftArcade_attempts', STATE.attempts);
      save('giftArcade_prizes', STATE.prizes);
      syncHeader(); renderLeaderboard(); filterGameView(); updateBestBadges(); updateAttemptBadges();
    }
    $('#nickInput').value = STATE.player.nickname || '';
    $('#roomInput').value = STATE.room.code || (new URLSearchParams(location.search).get('room') || '');
    $('#createGameSelect').value = STATE.room.gameKey || 'reaction';
    syncHeader();

    // 카운트다운
    let countdownTimer=null;
    function updateCountdown(){
      const n = Date.now();
      if (!STATE.room.startAt || !STATE.room.endAt){ $('#countdown').textContent='--:--'; return; }
      if (n < STATE.room.startAt){
        const s = Math.max(0, Math.floor((STATE.room.startAt - n)/1000));
        $('#countdown').textContent = `대기 ${pad(Math.floor(s/60))}:${pad(s%60)}`;
        STATE.room.status='waiting';
      } else if (n < STATE.room.endAt){
        const s = Math.floor((STATE.room.endAt - n)/1000);
        $('#countdown').textContent = `${pad(Math.floor(s/60))}:${pad(s%60)}`;
        STATE.room.status='live';
      } else {
        $('#countdown').textContent='종료';
        if (STATE.room.status!=='ended'){
          STATE.room.status='ended';
          onRoundEnded();
        }
      }
    }
    function startCountdownLoop(){ if (countdownTimer) clearInterval(countdownTimer); countdownTimer=setInterval(updateCountdown, 1000); updateCountdown(); }

    // 닉네임 기기 잠금
    function enforceDeviceNick(nick){
      if (!STATE.device.lockedNick){ STATE.device.lockedNick = nick; return true; }
      if (STATE.device.lockedNick && STATE.device.lockedNick !== nick){
        toast(`이 기기는 '${STATE.device.lockedNick}'만 사용 가능`);
        $('#nickInput').value = STATE.device.lockedNick; // 자동으로 기존 닉네임 설정
        return false;
      }
      return true;
    }

    // 방/참여
    function genRoomCode(){ const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let s=''; for(let i=0;i<6;i++) s+=c[rnd(0,c.length-1)]; return s }
    async function joinRoom(autoJoin = false){
      const nick = $('#nickInput').value.trim() || STATE.device.lockedNick || '';
      const code = ($('#roomInput').value||'').trim().toUpperCase();
      
      // 자동 입장 시 닉네임이 없으면 프롬프트
      if (autoJoin && !nick) {
        const inputNick = prompt('닉네임을 입력하세요 (예: 별빛토끼)');
        if (!inputNick) return;
        $('#nickInput').value = inputNick.trim();
        return joinRoom(false);
      }
      
      if (!nick) return toast('닉네임을 입력하세요');
      if (!code || code.length<3) return toast('방코드를 입력하세요');
      if (!enforceDeviceNick(nick)) {
        $('#nickInput').value = STATE.device.lockedNick;
        return joinRoom(autoJoin);
      }
      STATE.player.nickname = nick;
      STATE.room.code = code; STATE.room.isHost = false;
      saveAll();
      enterLobby();
      try{
        await firebaseAPI.ensureJoin(false);
      }catch(e){
        console.warn('join fallback offline', e);
      }
    }

    // 생성 시 임시 경품
    const CREATE_PRIZES = { '1':null, '2':null, '3':null };
    async function handleCreatePrize(rank, file, nameInputId, prevId){
      if (!file) return;
      const { dataURL, width, height, sizeKB } = await compressImage(file);
      const name = $(nameInputId).value.trim() || `${rank}등 경품`;
      CREATE_PRIZES[rank] = { image:dataURL, name, width, height, sizeKB };
      const box = $(prevId); box.innerHTML = '';
      const card = document.createElement('div'); card.className='prize-card';
      card.innerHTML = `<img class="thumb" src="${dataURL}" alt="${rank}등"><div class="meta"><span class="k">${name}</span><span class="sp"></span><span class="tag">${sizeKB}KB</span></div>`;
      box.append(card);
      toast(`${rank}등 경품 준비완료`);
    }
    $('#createPrizeFile1').addEventListener('change', e=> handleCreatePrize('1', e.target.files?.[0], '#createPrizeName1', '#createPrizePrev1'));
    $('#createPrizeFile2').addEventListener('change', e=> handleCreatePrize('2', e.target.files?.[0], '#createPrizeName2', '#createPrizePrev2'));
    $('#createPrizeFile3').addEventListener('change', e=> handleCreatePrize('3', e.target.files?.[0], '#createPrizeName3', '#createPrizePrev3'));
    
    // 경품명 입력 시 실시간 업데이트
    $('#createPrizeName1').addEventListener('input', e=> { if(CREATE_PRIZES['1']) CREATE_PRIZES['1'].name = e.target.value.trim() || '1등 경품'; });
    $('#createPrizeName2').addEventListener('input', e=> { if(CREATE_PRIZES['2']) CREATE_PRIZES['2'].name = e.target.value.trim() || '2등 경품'; });
    $('#createPrizeName3').addEventListener('input', e=> { if(CREATE_PRIZES['3']) CREATE_PRIZES['3'].name = e.target.value.trim() || '3등 경품'; });

    async function createRoom(){
      const minutes = parseInt($('#durationSel').value,10) || 10;
      const code = genRoomCode();
      const t = Date.now();
      const chosen = $('#createGameSelect').value;
      const limit = parseInt($('#createAttemptLimit').value||'0',10) || 0;
      if (!$('#nickInput').value.trim()){ $('#nickInput').value = '방장'; }
      const nick = $('#nickInput').value.trim();
      if (!enforceDeviceNick(nick)) return;
      STATE.player.nickname = nick;
      STATE.room.code = code;
      STATE.room.isHost = true;
      STATE.room.hostId = STATE.player.id;
      STATE.room.gameKey = chosen;
      STATE.room.limitPerGame = limit;
      STATE.room.startAt = t + 5000;
      STATE.room.endAt = STATE.room.startAt + minutes*60*1000;
      
      // 경품 저장 (이름 포함)
      for (const r of ['1','2','3']){
        if (CREATE_PRIZES[r]) {
          const nameInput = $(`#createPrizeName${r}`).value.trim();
          if (nameInput) CREATE_PRIZES[r].name = nameInput;
          STATE.prizes.local[r] = CREATE_PRIZES[r];
        }
      }
      
      saveAll();
      enterLobby();
      try{
        await firebaseAPI.ensureJoin(true);
        await firebaseAPI.pushRoomMeta();
        if (Object.keys(STATE.prizes.local).length) await firebaseAPI.pushPrizes();
      }catch(e){
        console.warn('createRoom: Firebase offline', e);
      }
      toast('새 방 생성 완료!');
    }

    function enterLobby(){
      $('#joinSection').classList.add('hidden');
      $('#lobbySection').classList.remove('hidden');
      $('#winnerSection').classList.add('hidden');
      syncHeader(); startCountdownLoop(); renderLeaderboard(); updateBestBadges(); filterGameView(); updateAttemptBadges();
    }
    
    // 기존 leaveRoom 함수를 찾아서 다음으로 교체
async function leaveRoom(){
  if (!STATE.room.code){ 
    $('#joinSection').classList.remove('hidden'); 
    $('#lobbySection').classList.add('hidden'); 
    $('#winnerSection').classList.add('hidden'); 
    return; 
  }
  
  // 모바일 친화적인 확인 방식
  const confirmLeave = window.confirm ? confirm('게임방을 나가시겠습니까?') : true;
  if (!confirmLeave) return;
  
  // Firebase 연결 해제 (에러 무시)
  try {
    await firebaseAPI.disconnect();
  } catch(e) {
    console.log('disconnect error ignored', e);
  }
  
  // 상태 초기화
  const keepNick = STATE.player.nickname;
  const keepDevice = STATE.device;
  STATE.room = { 
    code:'', 
    startAt:null, 
    endAt:null, 
    status:'waiting', 
    isHost:false, 
    hostId:null, 
    gameKey:'reaction', 
    limitPerGame:0 
  };
  STATE.player.nickname = keepNick;
  STATE.device = keepDevice;
  
  // 로컬 저장소 업데이트
  saveAll();
  
  // URL 파라미터 제거
  try {
    const url = new URL(window.location.href);
    url.searchParams.delete('room');
    window.history.replaceState(null, '', url.toString());
  } catch(e) {
    window.history.replaceState(null, '', window.location.pathname);
  }
  
  // 화면 전환
  $('#joinSection').classList.remove('hidden');
  $('#lobbySection').classList.add('hidden');
  $('#winnerSection').classList.add('hidden');
  
  // 카운트다운 타이머 정리
  if (countdownTimer) {
    clearInterval(countdownTimer);
    countdownTimer = null;
  }
  
  toast('메인으로 이동');
}

// 버튼 이벤트 리스너도 수정
$('#leaveBtn').addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();
  leaveRoom();
});

$('#backToMainBtn')?.addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();
  leaveRoom();
});


    // 게임 가시성
    function filterGameView(){
      const k = STATE.room.gameKey || 'reaction';

      $$('.game-card').forEach(card=>{
        const show = card.dataset.game === k;
        card.style.display = show ? '' : 'none';
        card.classList.toggle('game-disabled', card.dataset.game !== k);
      });
      $('#gameBadge').textContent = gameName(k);
    }

    // 리더보드
    let LAST_PLAYERS = [];
    function renderLeaderboard(players){
      const tbody = $('#leaderBody'); tbody.innerHTML='';
      let list = players || LAST_PLAYERS || [];
      if (!players){
        list = [{
          id: STATE.player.id, nickname: STATE.player.nickname||'(나)',
          scores: STATE.scores, score: scoreForGame(STATE.scores, STATE.room.gameKey), updatedAt: Date.now()
        }];
      }
      list = list.map(p=> ({ ...p, score: (p.score!=null)? p.score : scoreForGame(p.scores, STATE.room.gameKey) }));
      list.sort((a,b)=> (b.score||0) - (a.score||0) || (a.updatedAt||0) - (b.updatedAt||0));
      list.slice(0,50).forEach((p,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i<3? `<b>${i+1}</b>` : i+1}</td>
          <td>${p.nickname || '익명'}</td>
          <td><b>${fmt(Math.round(p.score||0))}</b></td>
          <td class="k">${detailForPlayer(p)}</td>
        `;
        tbody.appendChild(tr);
      });
      $('#lbStatus').textContent = STATE.connected ? '실시간' : '오프라인';
    }
    
    function updateBestBadges(){
      $('#reactionBest').textContent = STATE.scores.reaction.best || '-';
      $('#aimBest').textContent = STATE.scores.aim.best || '-';
      $('#aimAcc').textContent = STATE.scores.aim.acc ? `${STATE.scores.aim.acc}%` : '-';
      $('#moleBest').textContent = STATE.scores.mole.best || '-';
      $('#mathBest').textContent = STATE.scores.math.best || '-';
      $('#typingBest').textContent = STATE.scores.typing?.best || '-';
      $('#stroopBest').textContent = STATE.scores.stroop?.best || '-';
      $('#simonBest').textContent = STATE.scores.simon?.best || '-';
      $('#rhythmBest').textContent = STATE.scores.rhythm?.best || '-';
      $('#simonBestRound').textContent = STATE.scores.simon?.round || 0;
    }

    // 시도 제한
    function getAttemptLimit(){ return STATE.room.limitPerGame || 0 }
    function attemptsUsed(gameKey){
      const room = getRoomKey();
      STATE.attempts.byRoom[room] = STATE.attempts.byRoom[room] || {};
      return STATE.attempts.byRoom[room][gameKey] || 0;
    }
    function incAttempt(gameKey){
      const room = getRoomKey();
      STATE.attempts.byRoom[room] = STATE.attempts.byRoom[room] || {};
      STATE.attempts.byRoom[room][gameKey] = (STATE.attempts.byRoom[room][gameKey] || 0) + 1;
      saveAll();
      updateAttemptBadges();
    }
    function canStartGame(gameKey){
      if ((STATE.room.gameKey||'reaction') !== gameKey){ toast('다른 게임 진행 중'); return false; }
      if (STATE.room.status === 'ended'){ toast('라운드 종료됨'); return false; }
      const lim = getAttemptLimit();
      if (lim>0 && attemptsUsed(gameKey) >= lim){ toast('시도 제한 도달'); return false; }
      return true;
    }
    function updateAttemptBadges(){
      const lim = getAttemptLimit();
      for(const k of GAME_KEYS){
        const used = attemptsUsed(k);
        const el = $(`#attemptBad_${k}`); if (!el) continue;
        el.textContent = (STATE.room.gameKey===k) ? (lim ? `${used}/${lim}` : '무제한') : '비활성';
      }
      $('#limitBadge').textContent = lim? `${lim}회`:'무제한';
    }

    // 점수 제출
    async function submitScore(gameKey, normalized, extra={}){
      if (STATE.room.gameKey !== gameKey) return;
      if ((STATE.scores[gameKey]?.best||0) < normalized){
        STATE.scores[gameKey] = { best: normalized, ...extra };
        saveAll();
        await firebaseAPI.pushScore();
        renderLeaderboard();
      } else {
        await firebaseAPI.pushScore(true);
      }
    }
// 게임 로직 (모바일 최적화)
// 1) 반응속도
let reactionBusy=false;
$('#reactionStart').addEventListener('click', async ()=>{
  if (!canStartGame('reaction')) return;
  incAttempt('reaction');
  if (reactionBusy) return; reactionBusy=true;
  const area = $('#reactionArea'); area.innerHTML='';
  const panel = document.createElement('div'); panel.className='center';
  const msg = document.createElement('div'); msg.className='big';
  const sub = document.createElement('div'); sub.className='hint';
  const roundBox = document.createElement('div'); panel.append(msg,sub,roundBox); area.append(panel);
  let rounds=3, results=[];
  for (let i=1;i<=rounds;i++){
    msg.textContent='곧 시작...'; sub.textContent='녹색이 되면 터치!'; roundBox.textContent=`라운드 ${i}/3`;
    area.style.background='transparent';
    await delay(rnd(800,1600));
    let early=false, clicked=false;
    area.style.background = '#3b1620';
    const earlyClick = ()=> { early=true; };
    area.addEventListener('pointerdown', earlyClick, { once:true });
    await delay(rnd(500,1400));
    area.removeEventListener('pointerdown', earlyClick);
    area.style.background = '#183324';
    msg.textContent='터치!';
    const start = now();
    const onClick = ()=>{
      if (clicked) return; clicked=true;
      const t = now() - start;
      results.push(early? 9999 : t);
      area.removeEventListener('pointerdown', onClick);
    };
    area.addEventListener('pointerdown', onClick);
    let waited=0;
    while (results.length < i){ await delay(10); waited+=10; if (waited>6000){ results.push(9999); area.removeEventListener('pointerdown', onClick); break; } }
    msg.textContent = early? '성급!' : `${results[results.length-1]} ms`;
    sub.textContent = early? '페널티 9999ms' : '좋아요!';
    await delay(700);
  }
  const valid = results.map(v=> Math.min(v,1500));
  const avg = Math.round(valid.reduce((a,b)=>a+b,0)/valid.length);
  const score = clamp(Math.round(1200 - avg*2), 0, 1000);
  area.style.background='transparent';
  area.innerHTML = `<div class="center"><div class="big">평균 ${avg} ms</div><div class="hint">점수: ${score}</div><button class="btn acc" id="reactionRetry">다시</button></div>`;
  $('#reactionRetry').addEventListener('click', ()=>$('#reactionStart').click());
  await submitScore('reaction', score, { avg });
  reactionBusy=false;
});

// 2) 에임 (모바일 터치)
let aimRun=null;
$('#aimStart').addEventListener('click', startAim);
function startAim(){
  if (!canStartGame('aim')) return;
  incAttempt('aim');
  const area = $('#aimArea'); area.innerHTML='';
  const hud = document.createElement('div');
  hud.className='row'; hud.style.position='absolute'; hud.style.left='8px'; hud.style.top='8px'; hud.style.gap='6px';
  hud.innerHTML = `<div class="badge">30s</div><div class="badge">명중: <span id="aimHits">0</span></div><div class="badge">오: <span id="aimMiss">0</span></div><div class="badge"><span id="aimAccHud">0%</span></div>`;
  area.append(hud);
  const end = now() + 30_000;
  let hits=0, miss=0;
  const updateAcc = ()=> $('#aimAccHud').textContent = (hits+miss? Math.round(hits/(hits+miss)*100):0)+'%';
  const pop = (x,y,t="+100")=>{
    const el=document.createElement('div'); el.textContent=t; el.style.position='absolute'; el.style.left=x+'px'; el.style.top=y+'px'; el.style.color='#bdf6ff'; el.style.fontWeight='900'; el.style.pointerEvents='none';
    area.append(el); let dy=0; const iv=setInterval(()=>{ dy+=1; el.style.transform=`translateY(-${dy}px)`; el.style.opacity=(1-dy/40).toFixed(2); if(dy>40){clearInterval(iv); el.remove()} },16);
  }
  const onMiss = (e)=>{ const r=area.getBoundingClientRect(); miss++; $('#aimMiss').textContent=miss; pop(e.clientX-r.left, e.clientY-r.top,'-10'); updateAcc() };
  area.addEventListener('pointerdown', onMiss);
  function spawn(){
    if (now()>end) return;
    const size = rnd(32,48);
    const t = document.createElement('div');
    t.style.width=size+'px'; t.style.height=size+'px'; t.style.borderRadius='50%'; t.style.boxShadow='0 4px 16px rgba(0,0,0,.35)';
    t.style.background='radial-gradient(circle, #b9f7ff 0, #6ae3ff 45%, #0a3b44)'; t.style.border='2px solid #42b9cc88';
    const r = area.getBoundingClientRect();
    const x = rnd(10, Math.max(10, r.width - size - 10));
    const y = rnd(50, Math.max(50, r.height - size - 10));
    t.style.position='absolute'; t.style.left=x+'px'; t.style.top=y+'px';
    const hit=(e)=>{ e.stopPropagation(); hits++; $('#aimHits').textContent=hits; t.removeEventListener('pointerdown',hit); t.remove(); pop(x+size/2, y+size/2, '+100'); updateAcc() };
    t.addEventListener('pointerdown', hit);
    area.append(t);
    setTimeout(()=> t.isConnected && t.remove(), rnd(800,1200));
  }
  const spawner = setInterval(()=> spawn(), rnd(320,480));
  aimRun = setInterval(()=>{
    if (now()>end){
      clearInterval(aimRun); aimRun=null; clearInterval(spawner);
      const acc = hits+miss? Math.round(hits/(hits+miss)*100) : 0;
      const score = clamp(Math.round(hits*20 + acc*5 - miss*5), 0, 1000);
      area.removeEventListener('pointerdown', onMiss);
      area.innerHTML = `<div class="center"><div class="big">명중 ${hits}, ${acc}%</div><div class="hint">점수: ${score}</div><button class="btn acc" id="aimAgain">다시</button></div>`;
      $('#aimAgain').addEventListener('click', startAim);
      submitScore('aim', score, { acc, hits, miss });
    }
  }, 100);
}

// 3) 두더지 (모바일 터치)
let moleTimer=null, moleState={ running:false, hits:0, miss:0, endAt:0 };
function buildMoleGrid(){
  const grid = $('#moleGrid'); grid.innerHTML='';
  for (let i=0;i<16;i++){
    const cell=document.createElement('div'); cell.className='mole-cell';
    const m=document.createElement('div'); m.className='mole'; m.dataset.up='0';
    cell.append(m);
    cell.addEventListener('pointerdown', (e)=>{
      if (!moleState.running) return;
      if (m.dataset.up==='1'){
        m.style.filter='brightness(1.6) saturate(1.6)';
        moleState.hits++; $('#moleHits').textContent=moleState.hits;
        setTimeout(()=>{ m.style.filter=''; m.dataset.up='0'; m.style.top='100%'; }, 100);
      } else {
        moleState.miss++; $('#moleMiss').textContent=moleState.miss;
      }
    });
    grid.append(cell);
  }
}
buildMoleGrid();
$('#moleStart').addEventListener('click', ()=>{
  if (!canStartGame('mole')) return;
  incAttempt('mole');
  const moles = $$('#moleGrid .mole');
  moleState = { running:true, hits:0, miss:0, endAt: now()+30_000 };
  $('#moleHits').textContent='0'; $('#moleMiss').textContent='0'; $('#moleTime').textContent='30';
  if (moleTimer) clearInterval(moleTimer);
  let lastIdx=-1;
  moleTimer = setInterval(()=>{
    const t = Math.max(0, Math.ceil((moleState.endAt - now())/1000)); $('#moleTime').textContent=t;
    moles.forEach(m=>{ m.dataset.up='0'; m.style.top='100%'; });
    const holes = rnd(1,3);
    for (let i=0;i<holes;i++){
      let idx=rnd(0,moles.length-1);
      if (idx===lastIdx) idx=(idx+1)%moles.length;
      lastIdx=idx;
      const m=moles[idx];
      m.dataset.up='1'; m.style.top='50%';
      setTimeout(()=>{ if (m.dataset.up==='1'){ m.dataset.up='0'; m.style.top='100%'; } }, rnd(500,900));
    }
    if (now()>=moleState.endAt){
      clearInterval(moleTimer); moleTimer=null; moleState.running=false; moles.forEach(m=>{ m.dataset.up='0'; m.style.top='100%' });
      const acc = (moleState.hits + moleState.miss) ? (moleState.hits/(moleState.hits+moleState.miss)) : 0;
      const score = clamp(Math.round(moleState.hits*25 + acc*100 - moleState.miss*5), 0, 1000);
      toast(`종료! 점수 ${score}`); submitScore('mole', score, { hits:moleState.hits, miss:moleState.miss, acc: Math.round(acc*100) });
    }
  }, 700);
});

// 4) 수학 (모바일 키패드)
let mathRun=null; let math={ ok:0, streak:0, endAt:0, q:null, running:false };
function newQ(){ const ops=['+','+','+','-','x','x','+','-']; const op=ops[rnd(0,ops.length-1)]; let a,b; if(op==='+'||op==='-'){ a=rnd(10,99); b=rnd(5,99) } else { a=rnd(3,12); b=rnd(3,12) } const ans = op==='+'? a+b : op==='-'? a-b : a*b; return { t:`${a} ${op==='x'?'×':op} ${b}`, a:ans } }
function renderMathQ(){ $('#mathQ').textContent = math.q ? `${math.q.t} = ?` : '시작!' }
$('#mathStart').addEventListener('click', ()=>{
  if (!canStartGame('math')) return;
  incAttempt('math');
  math = { ok:0, streak:0, endAt: now()+60_000, q:newQ(), running:true };
  $('#mathOk').textContent='0'; $('#mathStreak').textContent='0'; $('#mathTime').textContent='60';
  renderMathQ(); $('#mathAns').value=''; $('#mathAns').disabled=false; $('#mathAns').focus();
  if (mathRun) clearInterval(mathRun);
  mathRun = setInterval(()=>{
    const t = Math.max(0, Math.ceil((math.endAt - now())/1000)); $('#mathTime').textContent=t;
    if (now()>=math.endAt){
      clearInterval(mathRun); mathRun=null; math.running=false;
      const score = clamp(Math.round(math.ok*60 + math.streak*10), 0, 1000);
      toast(`종료! 점수 ${score}`); submitScore('math', score, { ok:math.ok, streak:math.streak });
    }
  }, 250);
});
$('#mathAns').addEventListener('keydown', e=>{
  if (!math.running) return;
  if (e.key==='Enter'){
    const v = parseInt($('#mathAns').value, 10);
    if (v===math.q.a){ math.ok++; math.streak++; $('#mathOk').textContent=math.ok; $('#mathStreak').textContent=math.streak; math.q=newQ(); renderMathQ(); $('#mathAns').value='' }
    else { math.streak=0; $('#mathStreak').textContent='0'; $('#mathAns').select(); }
  }
});

// 5) 타자
const WORDS = 'quick snow ocean river star lucky gentle brave swift neon mango cherry zebra coffee pizza mirror cloud rocket galaxy lemon tiger panda music velvet window sunset orange kiwi breeze summit vector photon gamma delta alpha bravo echo foxtrot'.split(' ');
let typingRun=null, typing={ ok:0, charsOk:0, charsAll:0, endAt:0, running:false, word:'' };
function newWord(){ return WORDS[rnd(0,WORDS.length-1)]; }
function startTyping(){
  if (!canStartGame('typing')) return;
  incAttempt('typing');
  typing = { ok:0, charsOk:0, charsAll:0, endAt: now()+20_000, running:true, word:newWord() };
  $('#typingWord').textContent=typing.word; $('#typingOk').textContent='0'; $('#typingAcc').textContent='0%'; $('#typingTime').textContent='20';
  $('#typingInput').disabled=false; $('#typingInput').value=''; $('#typingInput').focus();
  if (typingRun) clearInterval(typingRun);
  typingRun = setInterval(()=>{
    const t = Math.max(0, Math.ceil((typing.endAt - now())/1000)); $('#typingTime').textContent=t;
    if (now()>=typing.endAt){
      clearInterval(typingRun); typingRun=null; typing.running=false; $('#typingInput').disabled=true;
      const acc = typing.charsAll? Math.round(typing.charsOk/typing.charsAll*100) : 0;
      const score = clamp(Math.round(typing.ok*50 + acc*3), 0, 1000);
      toast(`종료! 점수 ${score}`); submitScore('typing', score, { words:typing.ok, acc });
    }
  }, 200);
}
$('#typingStart').addEventListener('click', startTyping);
$('#typingInput').addEventListener('keydown', e=>{
  if (!typing.running) return;
  if (e.key==='Enter'){
    const v = $('#typingInput').value.trim();
    typing.charsAll += Math.max(v.length, typing.word.length);
    let ok=0; for (let i=0;i<Math.min(v.length, typing.word.length);i++){ if (v[i]===typing.word[i]) ok++; }
    typing.charsOk += ok;
    if (v===typing.word){ typing.ok++; $('#typingOk').textContent=typing.ok; }
    const acc = typing.charsAll? Math.round(typing.charsOk/typing.charsAll*100) : 0;
    $('#typingAcc').textContent=acc+'%';
    typing.word = newWord(); $('#typingWord').textContent=typing.word; $('#typingInput').value='';
  }
});

// 6) 스루프 (모바일 터치)
const COLORS = [
  {name:'RED', css:'#ff5c5c'}, {name:'BLUE', css:'#6aa8ff'}, {name:'GREEN', css:'#59d37d'}, {name:'YELLOW', css:'#ffd866'},
  {name:'PURPLE', css:'#c28bff'}, {name:'ORANGE', css:'#ffa76a'}
];
let stroopRun=null, stroop={ ok:0, wrong:0, endAt:0, running:false, targetCss:'#fff' };
function renderStroopButtons(){
  const row = $('#stroopBtns'); row.innerHTML='';
  COLORS.forEach(c=>{
    const b=document.createElement('button'); b.className='btn'; b.textContent=c.name;
    b.style.borderColor = c.css+'55'; b.style.background='linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03))'; b.style.color='#fff';
    b.addEventListener('click', ()=> onStroopChoose(c));
    row.append(b);
  });
}
function nextStroop(){
  const word = COLORS[rnd(0,COLORS.length-1)];
  const color = COLORS[rnd(0,COLORS.length-1)];
  $('#stroopWord').textContent = word.name;
  $('#stroopWord').style.color = color.css;
  stroop.targetCss = color.css;
}
function onStroopChoose(choice){
  if (!stroop.running) return;
  if (choice.css === stroop.targetCss){ stroop.ok++; $('#stroopOk').textContent=stroop.ok; }
  else { stroop.wrong++; $('#stroopWrong').textContent=stroop.wrong; }
  nextStroop();
}
$('#stroopStart').addEventListener('click', ()=>{
  if (!canStartGame('stroop')) return;
  incAttempt('stroop');
  stroop = { ok:0, wrong:0, endAt: now()+30_000, running:true, targetCss:'#fff' };
  $('#stroopOk').textContent='0'; $('#stroopWrong').textContent='0'; $('#stroopTime').textContent='30';
  renderStroopButtons(); nextStroop();
  if (stroopRun) clearInterval(stroopRun);
  stroopRun = setInterval(()=>{
    const t = Math.max(0, Math.ceil((stroop.endAt - now())/1000)); $('#stroopTime').textContent=t;
    if (now()>=stroop.endAt){
      clearInterval(stroopRun); stroopRun=null; stroop.running=false;
      const acc = (stroop.ok+stroop.wrong)? Math.round(stroop.ok/(stroop.ok+stroop.wrong)*100) : 0;
      const score = clamp(Math.round(stroop.ok*30 + acc*5 - stroop.wrong*2), 0, 1000);
      toast(`종료! 점수 ${score}`); submitScore('stroop', score, { ok:stroop.ok, wrong:stroop.wrong, acc });
    }
  }, 200);
});

// 7) 패턴 메모리 (모바일 터치)
let simon={ seq:[], inputIdx:0, round:0, running:false, pads:[], mode:'idle', bestRound: 0 };
function simonPads(){ return [$('#simonPad1'), $('#simonPad2'), $('#simonPad3'), $('#simonPad4')]; }
function simonFlash(el){
  const prev = el.style.filter; el.style.filter='brightness(1.7) saturate(1.4)'; el.style.boxShadow='0 0 18px rgba(255,255,255,.25)';
  setTimeout(()=>{ el.style.filter=prev||''; el.style.boxShadow=''; }, 220);
}
async function simonPlaySequence(){
  simon.mode='show';
  await delay(400);
  for (let i=0;i<simon.seq.length;i++){
    const p = simon.pads[simon.seq[i]];
    simonFlash(p);
    await delay(Math.max(260, 650 - simon.seq.length*20));
  }
  simon.mode='input';
}
function simonNextRound(){
  simon.seq.push(rnd(0,3));
  simon.round++; $('#simonRound').textContent=simon.round; simon.inputIdx=0;
  simonPlaySequence();
}
function startSimon(){
  if (!canStartGame('simon')) return;
  incAttempt('simon');
  simon = { seq:[], inputIdx:0, round:0, running:true, pads: simonPads(), mode:'idle', bestRound: STATE.scores.simon?.round||0 };
  $('#simonRound').textContent='0'; $('#simonBestRound').textContent = simon.bestRound || 0;
  simon.pads.forEach((p, idx)=>{
    p.style.cursor='pointer';
    p.onpointerdown = ()=>{
      if (!simon.running || simon.mode!=='input') return;
      simonFlash(p);
      if (simon.seq[simon.inputIdx] === idx){
        simon.inputIdx++;
        if (simon.inputIdx >= simon.seq.length){
          simonNextRound();
        }
      } else {
        simon.running=false; simon.mode='idle';
        const finalRound = simon.round;
        simon.bestRound = Math.max(simon.bestRound, finalRound);
        $('#simonBestRound').textContent = simon.bestRound;
        const score = clamp(simon.bestRound*80, 0, 1000);
        toast(`실패! 라운드 ${finalRound} (최고 ${simon.bestRound}) · 점수 ${score}`);
        submitScore('simon', score, { round: simon.bestRound });
      }
    };
  });
  simonNextRound();
}
$('#simonStart').addEventListener('click', startSimon);

// 8) 리듬 게임 (수정된 버전)
let rhythm = { 
  running: false, 
  startT: 0, 
  notes: [], 
  stage: null, 
  height: 420, 
  travel: 1600,
  stats: { perfect:0, great:0, good:0, miss:0, combo:0, bestCombo:0, hits:0, total:0, raw:0 },
  raf: null
};

function makeBeatmap(){
  const bpm = 120;
  const secPerBeat = 60_000/bpm;
  const beats = 40;
  const startDelay = 2000;
  const notes = [];
  
  for (let i=0; i<beats; i++){
    const lane = rnd(0,3);
    notes.push({ 
      lane, 
      time: startDelay + Math.round(i*secPerBeat),
      hit: false,
      spawned: false,
      el: null
    });
    
    if (Math.random() < 0.3){
      const lane2 = (lane + rnd(1,3)) % 4;
      notes.push({ 
        lane: lane2, 
        time: startDelay + Math.round(i*secPerBeat + secPerBeat/2),
        hit: false,
        spawned: false,
        el: null
      });
    }
  }
  
  notes.sort((a,b) => a.time - b.time);
  return notes;
}

function resetRhythmHUD(){
  $('#rhythmScore').textContent = '0';
  $('#rhythmCombo').textContent = '0';
  $('#rhythmAcc').textContent = '0%';
}

function rhythmSpawnNote(lane, y){
  const stage = rhythm.stage;
  const lanes = stage.querySelectorAll('.lane');
  if (!lanes[lane]) return null;
  
  const n = document.createElement('div');
  n.className = 'note';
  n.style.transform = `translateY(${y}px)`;
  lanes[lane].appendChild(n);
  return n;
}

function rhythmClearNotes(){
  if (!rhythm.stage) return;
  rhythm.stage.querySelectorAll('.note').forEach(n => n.remove());
}

function rhythmJudge(delta){
  const ad = Math.abs(delta);
  if (ad <= 50) return 'perfect';
  if (ad <= 100) return 'great';
  if (ad <= 150) return 'good';
  return 'miss';
}

function rhythmUpdateHUD(){
  const total = rhythm.stats.total || 1;
  const acc = Math.round((rhythm.stats.hits / total) * 100);
  $('#rhythmAcc').textContent = acc + '%';
  $('#rhythmCombo').textContent = rhythm.stats.combo;
  
  const potential = total * 10 || 1;
  const score = clamp(Math.round((rhythm.stats.raw / potential) * 1000), 0, 1000);
  $('#rhythmScore').textContent = score;
}

function rhythmEnd(){
  rhythm.running = false;
  
  document.removeEventListener('keydown', rhythmKeydown);

  $$('#rhythmStage .keycap').forEach(k => {
    k.onpointerdown = null;
    k.ontouchstart = null;
  });
  
  if (rhythm.raf) {
    cancelAnimationFrame(rhythm.raf);
    rhythm.raf = null;
  }
  
  rhythmClearNotes();
  
  const potential = rhythm.stats.total * 10 || 1;
  const score = clamp(Math.round((rhythm.stats.raw / potential) * 1000), 0, 1000);
  toast(`리듬 게임 종료! 점수: ${score}`);
  
  submitScore('rhythm', score, { 
    perfect: rhythm.stats.perfect,
    great: rhythm.stats.great,
    good: rhythm.stats.good,
    miss: rhythm.stats.miss,
    acc: Math.round((rhythm.stats.hits / (rhythm.stats.total || 1)) * 100) 
  });
}

function rhythmTryHitLane(lane){
  if (!rhythm.running) return;
  
  const tNow = performance.now() - rhythm.startT;
  let bestIdx = -1;
  let bestDelta = 999999;
  
  for (let i = 0; i < rhythm.notes.length; i++){
    const nt = rhythm.notes[i];
    if (nt.hit || nt.lane !== lane) continue;
    
    const delta = tNow - nt.time;
    const absDelta = Math.abs(delta);
    
    if (absDelta < 200 && absDelta < bestDelta){
      bestDelta = absDelta;
      bestIdx = i;
    }
  }
  
  if (bestIdx >= 0){
    const nt = rhythm.notes[bestIdx];
    const delta = tNow - nt.time;
    const judge = rhythmJudge(delta);
    
    nt.hit = true;
    rhythm.stats.total++;
    
    if (nt.el) {
      nt.el.style.opacity = '0';
      setTimeout(() => {
        if (nt.el && nt.el.parentNode) {
          nt.el.remove();
          nt.el = null;
        }
      }, 100);
    }
    
    if (judge === 'perfect'){
      rhythm.stats.perfect++;
      rhythm.stats.hits++;
      rhythm.stats.combo++;
      rhythm.stats.raw += 10;
    } else if (judge === 'great'){
      rhythm.stats.great++;
      rhythm.stats.hits++;
      rhythm.stats.combo++;
      rhythm.stats.raw += 7;
    } else if (judge === 'good'){
      rhythm.stats.good++;
      rhythm.stats.hits++;
      rhythm.stats.combo = 0;
      rhythm.stats.raw += 4;
    } else {
      rhythm.stats.miss++;
      rhythm.stats.combo = 0;
    }
    
    rhythm.stats.bestCombo = Math.max(rhythm.stats.bestCombo, rhythm.stats.combo);
    rhythmUpdateHUD();
  }
}

function rhythmKeydown(e){
  const key = e.key.toLowerCase();
  const map = { 'd':0, 'f':1, 'j':2, 'k':3 };
  if (key in map) {
    e.preventDefault();
    rhythmTryHitLane(map[key]);
  }
}

function rhythmLoop(){
  if (!rhythm.running) return;
  
  const t = performance.now() - rhythm.startT;
  const H = rhythm.height;
  const hitY = H - 54;
  
  for (const nt of rhythm.notes){
    if (nt.spawned || nt.hit) continue;
    
    if (t >= nt.time - rhythm.travel){
      nt.spawned = true;
      nt.el = rhythmSpawnNote(nt.lane, -20);
    }
  }
  
  for (const nt of rhythm.notes){
    if (!nt.spawned || !nt.el || nt.hit) continue;
    
    const elapsed = t - (nt.time - rhythm.travel);
    const progress = elapsed / rhythm.travel;
    const y = progress * (H + 20);
    
    nt.el.style.transform = `translateY(${y}px)`;
    
    if (!nt.hit && t - nt.time > 200){
      nt.hit = true;
      rhythm.stats.miss++;
      rhythm.stats.total++;
      rhythm.stats.combo = 0;
      rhythmUpdateHUD();
      
      if (nt.el) {
        nt.el.style.opacity = '0.3';
        setTimeout(() => {
          if (nt.el && nt.el.parentNode) {
            nt.el.remove();
            nt.el = null;
          }
        }, 200);
      }
    }
    
    if (y > H + 50){
      if (nt.el && nt.el.parentNode) {
        nt.el.remove();
        nt.el = null;
      }
    }
  }
  
  const allProcessed = rhythm.notes.every(n => n.hit);
  const allGone = rhythm.notes.every(n => !n.el);
  
  if (allProcessed && allGone){
    rhythmEnd();
    return;
  }
  
  rhythm.raf = requestAnimationFrame(rhythmLoop);
}

function startRhythm(){
  if (!canStartGame('rhythm')) return;
  incAttempt('rhythm');
  
  rhythm.stage = $('#rhythmStage');
  rhythm.height = rhythm.stage.clientHeight || 420;
  rhythm.travel = 1800;
  rhythm.notes = makeBeatmap();
  rhythm.stats = { perfect:0, great:0, good:0, miss:0, combo:0, bestCombo:0, hits:0, total:0, raw:0 };
  
  resetRhythmHUD();
  rhythmClearNotes();
  
  if (rhythm.raf) {
    cancelAnimationFrame(rhythm.raf);
    rhythm.raf = null;
  }
  
  rhythm.running = true;
  rhythm.startT = performance.now();
  
  document.addEventListener('keydown', rhythmKeydown);

  
  $$('#rhythmStage .keycap').forEach(k => {
    const lane = parseInt(k.dataset.lane, 10) || 0;
    
    const handleTouch = (e) => {
      e.preventDefault();
      e.stopPropagation();
      rhythmTryHitLane(lane);
      
      k.style.filter = 'brightness(1.5)';
      setTimeout(() => {
        k.style.filter = '';
      }, 100);
    };
    
    k.onpointerdown = handleTouch;
    k.ontouchstart = handleTouch;
  });
  
  rhythm.raf = requestAnimationFrame(rhythmLoop);
}
$('#rhythmStart').addEventListener('click', startRhythm);

    // 게임 로직은 이전과 동일 (생략)
    // ... [모든 게임 로직 코드는 이전과 동일]

    // 공유 (경품명과 종료 시간 포함)
    function roomURL(){
      const u = new URL(location.href); u.searchParams.set('room', STATE.room.code || ''); return u.toString();
    }
    
    function formatEndTime(){
      if (!STATE.room.endAt) return '';
      const d = new Date(STATE.room.endAt);
      const month = d.getMonth() + 1;
      const date = d.getDate();
      const hour = d.getHours();
      const min = pad(d.getMinutes());
      return `${month}/${date} ${hour}:${min}`;
    }
    
    async function shareText(title, text, url){
      if (navigator.share){
        try{ await navigator.share({ title, text, url }); return true; }catch(e){/* user cancel */ }
      }
      await copy(`${title}\n${text}\n${url}`); return false;
    }
    
    function getPrizeShareText(){
      const prizes = { ...STATE.prizes.local, ...STATE.prizes.remote };
      const prizeNames = [];
      if (prizes['1']?.name) prizeNames.push(`🥇 ${prizes['1'].name}`);
      if (prizes['2']?.name) prizeNames.push(`🥈 ${prizes['2'].name}`);
      if (prizes['3']?.name) prizeNames.push(`🥉 ${prizes['3'].name}`);
      
      const endTime = formatEndTime();
      const timeText = endTime ? `\n⏰ 종료: ${endTime}` : '';
      
      if (prizeNames.length > 0){
        return `🎁 기프티콘 배틀 아케이드\n\n경품:\n${prizeNames.join('\n')}\n\n📍 방코드: ${STATE.room.code}\n🎮 ${gameName(STATE.room.gameKey)} 게임${timeText}`;
      } else {
        return `🎮 기프티콘 배틀 아케이드\n📍 방코드: ${STATE.room.code}\n🎯 ${gameName(STATE.room.gameKey)} 게임으로 실시간 경쟁!${timeText}`;
      }
    }
    
    $('#shareBtn').addEventListener('click', ()=>{ if (!STATE.room.code) return toast('방코드가 없습니다'); shareText('기프티콘 배틀 아케이드', getPrizeShareText(), roomURL()); });
    $('#shareLinkBtn').addEventListener('click', ()=>{ 
      if (!STATE.room.code) return toast('방코드가 없습니다'); 
      shareText('기프티콘 배틀 아케이드', getPrizeShareText(), roomURL()); 
    });

    // 일반 버튼
    $('#joinBtn').addEventListener('click', ()=> joinRoom(false));
    $('#createRoomBtn').addEventListener('click', createRoom);
    $('#copyRoom').addEventListener('click', ()=> STATE.room.code? copy(STATE.room.code) : toast('방코드가 없습니다'));
    $('#refreshBtn').addEventListener('click', ()=> firebaseAPI.refresh());

    // Firebase API (이전과 동일, 생략)
    const firebaseAPI = {
      // ... [Firebase API 코드는 이전과 동일]
    };

    // URL에서 방코드 반영 및 자동 입장
    (async function initFromURL(){
      const roomParam = new URLSearchParams(location.search).get('room');
      if (roomParam){
        $('#roomInput').value = roomParam.toUpperCase();
        STATE.room.code = roomParam.toUpperCase();
        
        // 초대링크로 입장 시 자동 입장
        if (!STATE.player.nickname || STATE.player.nickname !== STATE.device.lockedNick){
          // 닉네임이 없거나 기기 잠금 닉네임과 다르면
          if (STATE.device.lockedNick){
            // 기기 잠금 닉네임이 있으면 자동 사용
            $('#nickInput').value = STATE.device.lockedNick;
            await joinRoom(true);
          } else {
            // 닉네임 입력 필요
            setTimeout(()=> {
              const nick = prompt('닉네임을 입력하세요 (예: 별빛토끼)');
              if (nick){
                $('#nickInput').value = nick.trim();
                joinRoom(true);
              }
            }, 500);
          }
        } else {
          // 이미 닉네임이 있으면 바로 입장
          await joinRoom(true);
        }
      } else if (STATE.room.code && STATE.player.nickname){
        // URL에 방코드가 없지만 저장된 정보가 있으면
        enterLobby();
        try{ await firebaseAPI.ensureJoin(STATE.room.isHost); }catch{}
      }
      
      startCountdownLoop();
    })();

  </script>
</body>
</html>
